<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FE Installation Project Scheduler</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, Helvetica, sans-serif; background: #ff0000; min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: rgba(255,255,255,0.95); border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);}
        h1 { color: #ff0000; margin-bottom: 30px; text-align: center; font-size: 2.5em; font-family: Arial, Helvetica, sans-serif; background: none; -webkit-background-clip: unset; background-clip: unset; -webkit-text-fill-color: unset;}
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e0e0e0;}
        .tab { padding: 12px 24px; background: none; border: none; cursor: pointer; font-size: 16px; color: #666; transition: all 0.3s; border-bottom: 3px solid transparent; margin-bottom: -2px;}
        .tab.active { color: #ff0000; border-bottom-color: #ff0000; font-weight: 600;}
        .tab:hover { color: #ff0000;}
        .section { display: none; animation: fadeIn 0.5s;}
        .section.active { display: block;}
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);}}
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, min-content); grid-auto-rows: min-content; gap: 20px; margin-bottom: 20px;}
        .form-group { display: flex; flex-direction: column;}
        label { font-weight: 600; color: #555; margin-bottom: 8px; font-size: 14px;}
        input, select, textarea { padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: all 0.3s;}
        input:focus, select:focus, textarea:focus { outline: none; border-color: #ff0000; box-shadow: 0 0 0 3px rgba(255,0,0,0.1);}
        textarea { resize: vertical; min-height: 100px;}
        .btn { padding: 12px 24px; background: linear-gradient(135deg, #ff0000, #b30000); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255,0,0,0.3);}
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,0,0,0.4);}
        .btn-secondary { background: #6c757d; box-shadow: 0 4px 15px rgba(108,117,125,0.3);}
        .btn-danger { background: #dc3545; box-shadow: 0 4-px 15px rgba(220,53,69,0.3);}
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s;}
        .card:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.15);}
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;}
        .card-title { font-size: 18px; font-weight: 600; color: #333;}
        .list-container { max-height: 500px; overflow-y: auto;}
        .schedule-output { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-top: 20px; min-height: 200px;}
        .schedule-day { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #ff0000;}
        .schedule-day h4 { color: #ff0000; margin-bottom: 10px;}
        .assignment { background: #fff0f0; padding: 10px; border-radius: 6px; margin-bottom: 8px;}
        .tech-tag { display: inline-block; background: #ff0000; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px;}
        .location-tag { display: inline-block; background: #b30000; color: white; padding: 4px 8px; border-radius: 4-px; font-size: 12px;}
        .scope-types { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;}
        .scope-type-card { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #e0e0e0;}
        .scope-type-card h5 { color: #ff0000; margin-bottom: 10px;}
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;}
        .metric-card { background: linear-gradient(135deg, #ff0000, #b30000); color: white; padding: 20px; border-radius: 12px; text-align: center;}
        .metric-value { font-size: 32px; font-weight: bold; margin-bottom: 5px;}
        .metric-label { font-size: 14px; opacity: 0.9;}
        .error { background: #fee; color: #c33; padding: 10px; border-radius: 6px; margin-top: 10px;}
        .success { background: #efe; color: #3c3; padding: 10px; border-radius: 6px; margin-top: 10px;}
        .project-list-container {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .project-item:hover {
            background-color: #f8f8f8;
        }
    </style>
    <!-- SheetJS for XLSX export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Use a callback function to ensure Google Maps API is loaded before usage -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCzV7sB-aIL3-OL2Z5EMW9TXvVEYjox7mw&libraries=places&callback=initMap" defer></script>
</head>
<body>
    <div class="container">
        <h1>FE Installation Project Scheduler</h1>
        <div class="tabs">
            <button class="tab active" type="button" data-tab="technicians">Technicians</button>
            <button class="tab" type="button" data-tab="locations">Locations</button>
            <button class="tab" type="button" data-tab="scopes">Scope Templates</button>
            <button class="tab" type="button" data-tab="schedule">Generate Schedule</button>
        </div>

        <!-- Technicians Section -->
        <div id="technicians" class="section active">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Add Technician Team</h3>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Base Location</label>
                        <input type="text" id="techLocation" placeholder="e.g., Downtown Hub">
                    </div>
                    <div class="form-group">
                        <label for="techAddress">Technician Address</label>
                        <input type="text" id="techAddress" name="techAddress" placeholder="e.g., 100 Main St, City, State ZIP" autocomplete="off" style="width:100%;" />
                    </div>
                    <div class="form-group">
                        <label>Number of Technicians</label>
                        <input type="number" id="techCount" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label>Team Name/ID</label>
                        <input type="text" id="techTeamName" placeholder="e.g., Team Alpha">
                    </div>
                    <div class="form-group">
                        <label>Availability (Days)</label>
                        <div id="techDaysCheckboxes" style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <label><input type="checkbox" value="Monday" checked> Monday</label>
                            <label><input type="checkbox" value="Tuesday" checked> Tuesday</label>
                            <label><input type="checkbox" value="Wednesday" checked> Wednesday</label>
                            <label><input type="checkbox" value="Thursday" checked> Thursday</label>
                            <label><input type="checkbox" value="Friday" checked> Friday</label>
                            <label><input type="checkbox" value="Saturday"> Saturday</label>
                            <label><input type="checkbox" value="Sunday"> Sunday</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Working Hours</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="time" id="techStartTime" value="08:00">
                            <input type="time" id="techEndTime" value="17:00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Providers (Certifications)</label>
                        <div id="techProviderCheckboxes" style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <!-- Provider checkboxes will be inserted here by JS -->
                        </div>
                    </div>
                </div>
                <button class="btn" id="addTechBtn" onclick="addTechnician()">Add Technician Team</button>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Current Technician Teams</h3>
                </div>
                <div id="technicianList" class="list-container"></div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Import Technician Data from CSV</h3>
                </div>
                <p style="margin-bottom: 10px; font-size: 14px; color: #555;">Paste comma-separated data below. Format: `Team Name,Base Location,Technician Address,Number of Technicians,Availability(Mon;Tue;...),Working Hours(08:00-17:00),Providers(Motive;Lytx;...)`</p>
                <textarea id="csvData" rows="5" placeholder="Paste your CSV data here..."></textarea>
                <button class="btn" style="margin-top: 10px;" onclick="importTechnicians()">Load Technicians</button>
            </div>
        </div>

        <!-- Locations Section -->
        <div id="locations" class="section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Project Providers (Applies to all locations)</h3>
                </div>
                <div id="projectProviderCheckboxes" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <!-- Provider checkboxes will be inserted here by JS -->
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Add Installation Location</h3>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Site ID</label>
                        <input type="text" id="locationId" placeholder="e.g., SITE-001">
                    </div>
                    <div class="form-group">
                        <label>Site Name</label>
                        <input type="text" id="locationName" placeholder="e.g., Main Street Branch">
                    </div>
                    <div class="form-group">
                        <label for="locationAddress">Full Address</label>
                        <input type="text" id="locationAddress" name="locationAddress" placeholder="123 Main St, City, State ZIP" autocomplete="off" style="width:100%;" />
                    </div>
                    <div class="form-group">
                        <label>Scope of Work</label>
                        <input type="text" id="locationScope" placeholder="e.g., 15 VG + DCs, 5 PAs">
                    </div>
                    <div class="form-group">
                        <label>Priority Level</label>
                        <select id="locationPriority">
                            <option value="High">High</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Site Availability (Days)</label>
                        <div id="locationDayCheckboxes" style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <label><input type="checkbox" value="Monday" checked> Monday</label>
                            <label><input type="checkbox" value="Tuesday" checked> Tuesday</label>
                            <label><input type="checkbox" value="Wednesday" checked> Wednesday</label>
                            <label><input type="checkbox" value="Thursday" checked> Thursday</label>
                            <label><input type="checkbox" value="Friday" checked> Friday</label>
                            <label><input type="checkbox" value="Saturday"> Saturday</label>
                            <label><input type="checkbox" value="Sunday"> Sunday</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Site Hours</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="time" id="locationStartTime" value="09:00">
                            <input type="time" id="locationEndTime" value="17:00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Contact Person</label>
                        <input type="text" id="locationContact" placeholder="Name and phone">
                    </div>
                    <div class="form-group">
                        <label>Special Requirements</label>
                        <textarea id="locationNotes" placeholder="Access codes, parking info, etc."></textarea>
                    </div>
                </div>
                <button class="btn" onclick="addLocation()">Add Location</button>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Current Locations</h3>
                </div>
                <div id="locationList" class="list-container"></div>
            </div>
        </div>

        <!-- Scopes Section -->
        <div id="scopes" class="section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Define Scope Templates</h3>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Scope Type</label>
                        <input type="text" id="scopeType" placeholder="e.g., VG, DC, PA">
                    </div>
                    <div class="form-group">
                        <label>Duration per Unit (minutes)</label>
                        <input type="number" id="scopeDuration" min="1" placeholder="e.g., 30">
                    </div>
                    <div class="form-group">
                        <label>Required Tech Count</label>
                        <input type="number" id="scopeTechCount" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label>Complexity Factor</label>
                        <select id="scopeComplexity">
                            <option value="1">Simple (1x)</option>
                            <option value="1.5">Moderate (1.5x)</option>
                            <option value="2">Complex (2x)</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="addScope()">Add Scope Template</button>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Current Scope Templates</h3>
                </div>
                <div id="scopeList" class="scope-types"></div>
            </div>
        </div>

        <!-- Schedule Section -->
        <div id="schedule" class="section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Schedule Parameters</h3>
                </div>
                <div class="form-grid">
                    <div class="form-group" style="display:none">
                        <label>Average Drive Time (minutes)</label>
                        <input type="number" id="driveTime" value="30" min="0">
                    </div>
                    <div class="form-group">
                        <label>Optimization Strategy</label>
                        <select id="optimizationStrategy">
                            <option value="efficiency">Maximum Efficiency</option>
                            <option value="priority">Priority First</option>
                            <option value="balanced">Balanced Approach</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Install Window Start</label>
                        <input type="date" id="installWindowStart" value="">
                    </div>
                    <div class="form-group">
                        <label>Install Window End</label>
                        <input type="date" id="installWindowEnd" value="">
                    </div>
                </div>
                <div style="color:#888; font-size:13px; margin-bottom:10px;">
                    <em>Drive time is now automatically estimated based on technician and location addresses.<br>
                    Buffer time is now always automated (minimum 15 minutes before each job).</em>
                </div>
                <button class="btn" onclick="generateSchedule()">🚀 Generate Optimal Schedule</button>
                <button class="btn btn-secondary" id="overrideBtn" onclick="overrideUnassignedSchedule()" style="margin-left:10px; display:none;">Override Parameters</button>
                <button class="btn" onclick="exportToXLSX()" style="margin-left: 10px;">Export to XLSX</button>
            </div>
            <div class="metrics" id="metrics"></div>
            <div class="schedule-output" id="scheduleOutput">
                <h3>Generated Schedule will appear here...</h3>
            </div>
        </div>
    </div>
    <script>
        // --- Data and UI Logic ---
        let technicians = [];
        let locations = [];
        let scopes = [];
        let projectProviders = [];
        let editTechId = null;
        let editLocationId = null;
        const providers = ["Motive", "Lytx", "Samsara", "Verizon Connect", "Vestige", "LinxUp"];

        // Add a global to store last unassigned locations
        let lastUnassignedLocations = [];

        // Store last generated schedule and assignments for override
        let lastSchedule = {};
        let lastAssignments = [];

        // --- Data Persistence (using Local Storage now) ---
        function saveAllData() {
            localStorage.setItem('technicians', JSON.stringify(technicians));
            localStorage.setItem('locations', JSON.stringify(locations));
            localStorage.setItem('scopes', JSON.stringify(scopes));
            localStorage.setItem('projectProviders', JSON.stringify(projectProviders));
        }
        function loadAllData() {
            const techs = localStorage.getItem('technicians');
            const locs = localStorage.getItem('locations');
            const scps = localStorage.getItem('scopes');
            const projs = localStorage.getItem('projectProviders');
            const lastSched = localStorage.getItem('lastSchedule');
            const lastUnassigned = localStorage.getItem('lastUnassignedLocations');

            if (techs) {
                technicians = JSON.parse(techs);
                technicians.forEach(tech => {
                    if (!tech.providers) tech.providers = [];
                });
            }
            if (locs) {
                locations = JSON.parse(locs);
                locations.forEach(loc => {
                    if (!loc.days) loc.days = [];
                });
            }
            if (scps) scopes = JSON.parse(scps);
            if (projs) projectProviders = JSON.parse(projs);
            if (lastSched) {
                lastSchedule = JSON.parse(lastSched);
                // Re-parse dates from string to Date objects
                Object.values(lastSchedule).forEach(day => {
                    if (day.date) {
                        day.date = new Date(day.date);
                    }
                    day.teams.forEach(team => {
                        team.assignments.forEach(assignment => {
                            assignment.startDateTime = new Date(assignment.startDateTime);
                            assignment.endDateTime = new Date(assignment.endDateTime);
                        });
                    });
                });
            }
            if (lastUnassigned) lastUnassignedLocations = JSON.parse(lastUnassigned);
        }
        function saveScheduleState() {
            localStorage.setItem('lastSchedule', JSON.stringify(lastSchedule));
            localStorage.setItem('lastUnassignedLocations', JSON.stringify(lastUnassignedLocations));
        }
        function clearScheduleState() {
            localStorage.removeItem('lastSchedule');
            localStorage.removeItem('lastUnassignedLocations');
        }
        
        function getCurrentTabName() {
            const activeTab = document.querySelector('.tab.active');
            if (!activeTab) return 'technicians';
            return activeTab.getAttribute('data-tab');
        }
        function setCurrentTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const tabBtn = document.querySelector(`.tab[data-tab="${tabName}"]`);
            if (tabBtn) {
                tabBtn.classList.add('active');
                const section = document.getElementById(tabName);
                if (section) section.classList.add('active');
            }
            if (tabName === 'scopes') {
                updateScopeList();
            }
            if (tabName === 'schedule') {
                updateScheduleTabContent();
                displaySchedule(lastSchedule, lastUnassignedLocations);
                displayMetrics(lastSchedule, lastUnassignedLocations);
            }
        }

        // --- Tab Logic (robust, no inline onclick, fluid UI) ---
        document.addEventListener('DOMContentLoaded', function () {
            // Tab click handler
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    tab.classList.add('active');
                    const tabName = tab.getAttribute('data-tab');
                    const section = document.getElementById(tabName);
                    if (section) section.classList.add('active');
                    localStorage.setItem('currentTab', tabName);
                    if (tabName === 'scopes') {
                        updateScopeList();
                    }
                    if (tabName === 'schedule') {
                        updateScheduleTabContent();
                        displaySchedule(lastSchedule, lastUnassignedLocations);
                        displayMetrics(lastSchedule, lastUnassignedLocations);
                    }
                });
            });
            loadAllData();
            const savedTab = localStorage.getItem('currentTab') || 'technicians';
            setCurrentTab(savedTab);
        });

        // The initMap function is now a global callback function for the Google Maps script
        function initMap() {
            // Technician Address Autocomplete
            const techInput = document.getElementById('techAddress');
            if(techInput) {
                const techAutocomplete = new google.maps.places.Autocomplete(techInput, { types: ['address'] });
                techAutocomplete.setFields(['formatted_address']);
                techAutocomplete.addListener('place_changed', function() {
                    const place = techAutocomplete.getPlace();
                    if (place && place.formatted_address) {
                        techInput.value = place.formatted_address;
                    }
                });
            }

            // Location Address Autocomplete
            const locInput = document.getElementById('locationAddress');
            if (locInput) {
                const locAutocomplete = new google.maps.places.Autocomplete(locInput, { types: ['address'] });
                locAutocomplete.setFields(['formatted_address']);
                locAutocomplete.addListener('place_changed', function() {
                    const place = locAutocomplete.getPlace();
                    if (place && place.formatted_address) {
                        locInput.value = place.formatted_address;
                    }
                });
            }
        }

        function populateProviderCheckboxes() {
            const techContainer = document.getElementById('techProviderCheckboxes');
            const locationContainer = document.getElementById('projectProviderCheckboxes');
            
            if (techContainer) {
                techContainer.innerHTML = providers.map(p => `<label><input type="checkbox" value="${p}"> ${p}</label>`).join('');
            }
            if (locationContainer) {
                locationContainer.innerHTML = providers.map(p => `<label><input type="checkbox" value="${p}" onchange="updateProjectProviders()"> ${p}</label>`).join('');
                setSelectedProviders('projectProviderCheckboxes', projectProviders);
            }
        }
        
        function updateProjectProviders() {
            const container = document.getElementById('projectProviderCheckboxes');
            if (container) {
                projectProviders = Array.from(container.querySelectorAll(`input[type="checkbox"]:checked`)).map(cb => cb.value);
                saveAllData();
                updateLocationList();
            }
        }

        function getSelectedProviders(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return [];
            return Array.from(container.querySelectorAll(`input[type="checkbox"]:checked`)).map(cb => cb.value);
        }
        
        function setSelectedProviders(containerId, selectedProviders) {
            document.querySelectorAll(`#${containerId} input[type="checkbox"]`).forEach(cb => {
                cb.checked = (selectedProviders || []).includes(cb.value);
            });
        }
        
        // --- New function to import technicians from CSV paste ---
        function importTechnicians() {
            const csvData = document.getElementById('csvData').value;
            const lines = csvData.split('\n').filter(line => line.trim() !== '');
            const newTechnicians = [];
            let errors = [];

            lines.forEach((line, index) => {
                const parts = line.split(',');
                if (parts.length < 7) {
                    errors.push(`Row ${index + 1}: Not enough data. Expected 7 columns.`);
                    return;
                }

                const [teamName, location, address, count, days, hours, providers] = parts.map(p => p.trim());
                const [startTime, endTime] = hours.split('-').map(h => h.trim());

                if (!teamName || !location || !address || !count || !days || !hours || !providers) {
                    errors.push(`Row ${index + 1}: Missing required data.`);
                    return;
                }
                if (technicians.some(t => t.teamName === teamName) || newTechnicians.some(t => t.teamName === teamName)) {
                    errors.push(`Row ${index + 1}: Duplicate Team Name/ID.`);
                    return;
                }

                newTechnicians.push({
                    id: Date.now() + index, // Unique ID
                    teamName,
                    location,
                    address,
                    count: parseInt(count),
                    days: days.split(';').map(d => d.trim()),
                    startTime,
                    endTime,
                    specializations: [], // Legacy field
                    providers: providers.split(';').map(p => p.trim())
                });
            });

            if (errors.length > 0) {
                alert("Please fix the following errors in your data:\n" + errors.join("\n"));
                return;
            }

            technicians = [...technicians, ...newTechnicians];
            updateTechnicianList();
            saveAllData();
            document.getElementById('csvData').value = '';
            alert(`${newTechnicians.length} technician teams successfully imported.`);
        }

        // --- Scope List always updates ---
        function updateScopeList() {
            const list = document.getElementById('scopeList');
            if (!list) return;
            if (scopes.length === 0) {
                list.innerHTML = '<p style="color:#888;">No scope templates defined yet.</p>';
                return;
            }
            list.innerHTML = scopes.map(scope => `
                <div class="scope-type-card">
                    <h5>${scope.type}</h5>
                    <p><strong>Duration:</strong> ${scope.duration} min/unit</p>
                    <p><strong>Tech Required:</strong> ${scope.techCount}</p>
                    <p><strong>Complexity:</strong> ${scope.complexity}x</p>
                    <button class="btn btn-danger" onclick="removeScope(${scope.id})">Remove</button>
                </div>
            `).join('');
        }

        // --- Schedule Tab always shows content ---
        function updateScheduleTabContent() {
            const scheduleOutput = document.getElementById('scheduleOutput');
            if (!scheduleOutput) return;
            if (scopes.length === 0) {
                scheduleOutput.innerHTML = '<div class="error">Please define at least one scope template before generating a schedule.</div>';
            } else if (technicians.length === 0 || locations.length === 0) {
                scheduleOutput.innerHTML = '<div class="error">Please add at least one technician team and one location before generating a schedule.</div>';
            } else {
                scheduleOutput.innerHTML = '<h3>Generated Schedule will appear here...</h3>';
            }
            displayMetrics({}, []);
        }

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            updateTechnicianList();
            updateLocationList();
            updateScopeList();
            // Restore tab
            const savedTab = localStorage.getItem('currentTab') || 'technicians';
            setCurrentTab(savedTab);
            // Ensure scope and schedule sections are populated
            updateScopeList();
            updateScheduleTabContent();
        });

        // --- Helper function to format 24h time to 12h AM/PM ---
        function formatTime(timeString) {
            if (!timeString) return '';
            const [hour, minute] = timeString.split(':');
            const h = parseInt(hour, 10);
            const m = parseInt(minute, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const formattedHour = h % 12 === 0 ? 12 : h % 12;
            return `${formattedHour}:${m.toString().padStart(2, '0')} ${ampm}`;
        }

        // --- Technician CRUD ---
        function getSelectedTechDays() {
            const container = document.getElementById('techDaysCheckboxes');
            if (!container) return [];
            return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        }
        function setSelectedTechDays(days) {
            document.querySelectorAll('#techDaysCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = (days || []).includes(cb.value);
            });
        }
        function addTechnician() {
            const location = document.getElementById('techLocation')?.value.trim();
            const address = document.getElementById('techAddress')?.value.trim();
            const count = parseInt(document.getElementById('techCount')?.value);
            const teamName = document.getElementById('techTeamName')?.value.trim();
            const days = getSelectedTechDays();
            const startTime = document.getElementById('techStartTime')?.value;
            const endTime = document.getElementById('techEndTime')?.value;
            const specializations = document.getElementById('techSpecializations')?.value.split(',').map(s => s.trim()).filter(Boolean) || [];
            const providers = getSelectedProviders('techProviderCheckboxes');

            let errors = [];
            if (!location) errors.push("Base Location is required.");
            if (!address) errors.push("Technician Address is required.");
            if (!count || count < 1) errors.push("Number of Technicians must be at least 1.");
            if (!teamName) errors.push("Team Name/ID is required.");
            if (days.length === 0) errors.push("At least one availability day must be selected.");
            if (!startTime || !endTime) errors.push("Working hours are required.");
            if (technicians.some(t => t.teamName === teamName && t.id !== editTechId)) errors.push("Team Name/ID must be unique.");
            if (providers.length === 0) errors.push("At least one provider must be selected.");

            if (errors.length > 0) {
                alert("Please fix the following:\n" + errors.join("\n"));
                return;
            }

            if (editTechId !== null) {
                const idx = technicians.findIndex(t => t.id === editTechId);
                if (idx !== -1) {
                    technicians[idx] = { id: editTechId, location, address, count, teamName, days, startTime, endTime, specializations, providers };
                }
                editTechId = null;
                document.getElementById('addTechBtn').textContent = "Add Technician Team";
            } else {
                const tech = { id: Date.now(), location, address, count, teamName, days, startTime, endTime, specializations, providers };
                technicians.push(tech);
            }
            updateTechnicianList();
            clearTechForm();
            saveAllData();
        }
        function clearTechForm() {
            if (document.getElementById('techLocation')) document.getElementById('techLocation').value = '';
            if (document.getElementById('techAddress')) document.getElementById('techAddress').value = '';
            if (document.getElementById('techCount')) document.getElementById('techCount').value = '1';
            if (document.getElementById('techTeamName')) document.getElementById('techTeamName').value = '';
            if (document.getElementById('techSpecializations')) document.getElementById('techSpecializations').value = '';
            setSelectedTechDays(['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday']);
            setSelectedProviders('techProviderCheckboxes', []);
            if (document.getElementById('techStartTime')) document.getElementById('techStartTime').value = '08:00';
            if (document.getElementById('techEndTime')) document.getElementById('techEndTime').value = '17:00';
            editTechId = null;
            if (document.getElementById('addTechBtn')) document.getElementById('addTechBtn').textContent = "Add Technician Team";
        }
        function updateTechnicianList() {
            const list = document.getElementById('technicianList');
            if (technicians.length === 0) {
                list.innerHTML = '<p style="color:#888;">No technician teams added yet.</p>';
                return;
            }
            list.innerHTML = technicians.map(tech => `
                <div class="card">
                    <div class="card-header">
                        <strong>${tech.teamName}</strong>
                        <div>
                            <button class="btn btn-secondary" onclick="editTechnician(${tech.id})">Edit</button>
                            <button class="btn btn-danger" onclick="removeTechnician(${tech.id})">Remove</button>
                        </div>
                    </div>
                    <div>
                        <p><strong>Location:</strong> ${tech.location}</p>
                        <p><strong>Address:</strong> ${tech.address || '-'}</p>
                        <p><strong>Team Size:</strong> ${tech.count} technicians</p>
                        <p><strong>Available:</strong> ${tech.days.join(', ')}</p>
                        <p><strong>Hours:</strong> ${formatTime(tech.startTime)} - ${formatTime(tech.endTime)}</p>
                        <p><strong>Certifications:</strong> ${(tech.providers || []).join(', ') || 'None'}</p>
                    </div>
                </div>
            `).join('');
        }
        function editTechnician(id) {
            const tech = technicians.find(t => t.id === id);
            if (!tech) return;
            if (document.getElementById('techLocation')) document.getElementById('techLocation').value = tech.location;
            if (document.getElementById('techAddress')) document.getElementById('techAddress').value = tech.address;
            if (document.getElementById('techCount')) document.getElementById('techCount').value = tech.count;
            if (document.getElementById('techTeamName')) document.getElementById('techTeamName').value = tech.teamName;
            if (document.getElementById('techSpecializations')) document.getElementById('techSpecializations').value = tech.specializations?.join(', ') || '';
            setSelectedTechDays(tech.days);
            setSelectedProviders('techProviderCheckboxes', tech.providers || []);
            if (document.getElementById('techStartTime')) document.getElementById('techStartTime').value = tech.startTime;
            if (document.getElementById('techEndTime')) document.getElementById('techEndTime').value = tech.endTime;
            editTechId = id;
            if (document.getElementById('addTechBtn')) document.getElementById('addTechBtn').textContent = "Save Technician Team";
            if (document.getElementById('techLocation')) document.getElementById('techLocation').focus();
        }
        function removeTechnician(id) {
            technicians = technicians.filter(t => t.id !== id);
            updateTechnicianList();
            saveAllData();
        }

        // --- Location CRUD ---
        function getSelectedLocationDays() {
            const container = document.getElementById('locationDayCheckboxes');
            if (!container) return [];
            return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        }

        function setSelectedLocationDays(days) {
            document.querySelectorAll('#locationDayCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = (days || []).includes(cb.value);
            });
        }

        function addLocation() {
            const siteId = document.getElementById('locationId')?.value.trim();
            const name = document.getElementById('locationName')?.value.trim();
            const address = document.getElementById('locationAddress')?.value.trim();
            const scope = document.getElementById('locationScope')?.value.trim();
            const priority = document.getElementById('locationPriority')?.value;
            const days = getSelectedLocationDays();
            const startTime = document.getElementById('locationStartTime')?.value;
            const endTime = document.getElementById('locationEndTime')?.value;
            const contact = document.getElementById('locationContact')?.value.trim();
            const notes = document.getElementById('locationNotes')?.value.trim();

            let errors = [];
            if (!siteId) errors.push("Site ID is required.");
            if (!address) errors.push("Full Address is required.");
            if (!scope) errors.push("Scope of Work is required.");
            if (locations.some(l => l.siteId === siteId && l.id !== editLocationId)) errors.push("Site ID must be unique.");
            if (projectProviders.length === 0) errors.push("At least one provider must be selected for the project.");
            if (days.length === 0) errors.push("At least one availability day must be selected.");
            if (!startTime || !endTime) errors.push("Site hours are required.");

            const scopeItems = parseScope(scope);
            const missingScopes = scopeItems.filter(item =>
                !scopes.some(s =>
                    item.type.toLowerCase().includes(s.type.toLowerCase()) ||
                    s.type.toLowerCase().includes(item.type.toLowerCase())
                )
            );
            if (missingScopes.length > 0) {
                alert("Please fix the following:\n" + "Scope type(s) not defined: " + missingScopes.map(s => s.type).join(', '));
                return;
            }

            if (errors.length > 0) {
                alert("Please fix the following:\n" + errors.join("\n"));
                return;
            }

            if (editLocationId !== null) {
                const idx = locations.findIndex(l => l.id === editLocationId);
                if (idx !== -1) {
                    locations[idx] = { id: editLocationId, siteId, name, address, scope, priority, days, startTime, endTime, contact, notes, providers: projectProviders };
                }
                editLocationId = null;
                document.querySelector('button[onclick="addLocation()"]').textContent = "Add Location";
            } else {
                const location = { id: Date.now(), siteId, name, address, scope, priority, days, startTime, endTime, contact, notes, providers: projectProviders };
                locations.push(location);
            }
            updateLocationList();
            clearLocationForm();
            saveAllData();
        }
        function updateLocationList() {
            const list = document.getElementById('locationList');
            if (locations.length === 0) {
                list.innerHTML = '<p style="color:#888;">No locations added yet.</p>';
                return;
            }
            list.innerHTML = locations.map(loc => `
                <div class="card">
                    <div class="card-header">
                        <strong>${loc.siteId} - ${loc.name || 'Unnamed'}</strong>
                        <div>
                            <button class="btn btn-secondary" onclick="editLocation(${loc.id})">Edit</button>
                            <button class="btn btn-danger" onclick="removeLocation(${loc.id})">Remove</button>
                        </div>
                    </div>
                    <div>
                        <p><strong>Address:</strong> ${loc.address}</p>
                        <p><strong>Scope:</strong> ${loc.scope}</p>
                        <p><strong>Priority:</strong> <span class="tech-tag">${loc.priority}</span></p>
                        <p><strong>Availability:</strong> ${(loc.days || []).join(', ')} (${formatTime(loc.startTime)} - ${formatTime(loc.endTime)})</p>
                        <p><strong>Providers:</strong> ${(projectProviders || []).join(', ') || 'None'}</p>
                        ${loc.contact ? `<p><strong>Contact:</strong> ${loc.contact}</p>` : ''}
                        ${loc.notes ? `<p><strong>Notes:</strong> ${loc.notes}</p>` : ''}
                    </div>
                </div>
            `).join('');
        }
        function editLocation(id) {
            const loc = locations.find(l => l.id === id);
            if (!loc) return;
            if (document.getElementById('locationId')) document.getElementById('locationId').value = loc.siteId;
            if (document.getElementById('locationName')) document.getElementById('locationName').value = loc.name;
            if (document.getElementById('locationAddress')) document.getElementById('locationAddress').value = loc.address;
            if (document.getElementById('locationScope')) document.getElementById('locationScope').value = loc.scope;
            if (document.getElementById('locationPriority')) document.getElementById('locationPriority').value = loc.priority;
            setSelectedLocationDays(loc.days || []);
            if (document.getElementById('locationStartTime')) document.getElementById('locationStartTime').value = loc.startTime;
            if (document.getElementById('locationEndTime')) document.getElementById('locationEndTime').value = loc.endTime;
            if (document.getElementById('locationContact')) document.getElementById('locationContact').value = loc.contact;
            if (document.getElementById('locationNotes')) document.getElementById('locationNotes').value = loc.notes;
            editLocationId = id;
            if (document.querySelector('button[onclick="addLocation()"]')) document.querySelector('button[onclick="addLocation()"]').textContent = "Save Location";
            if (document.getElementById('locationId')) document.getElementById('locationId').focus();
        }
        function removeLocation(id) {
            locations = locations.filter(l => l.id !== id);
            updateLocationList();
            clearLocationForm();
            saveAllData();
        }
        function clearLocationForm() {
            if (document.getElementById('locationId')) document.getElementById('locationId').value = '';
            if (document.getElementById('locationName')) document.getElementById('locationName').value = '';
            if (document.getElementById('locationAddress')) document.getElementById('locationAddress').value = '';
            if (document.getElementById('locationScope')) document.getElementById('locationScope').value = '';
            setSelectedLocationDays(['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday']);
            if (document.getElementById('locationStartTime')) document.getElementById('locationStartTime').value = '09:00';
            if (document.getElementById('locationEndTime')) document.getElementById('locationEndTime').value = '17:00';
            if (document.getElementById('locationContact')) document.getElementById('locationContact').value = '';
            if (document.getElementById('locationNotes')) document.getElementById('locationNotes').value = '';
            if (document.getElementById('locationPriority')) document.getElementById('locationPriority').value = 'Medium';
            editLocationId = null;
            if (document.querySelector('button[onclick="addLocation()"]')) document.querySelector('button[onclick="addLocation()"]').textContent = "Add Location";
            currentLocationScopes = [];
        }

        // --- Scope CRUD ---
        function addScope() {
            const type = document.getElementById('scopeType')?.value.trim();
            const duration = parseInt(document.getElementById('scopeDuration')?.value);
            const techCount = parseInt(document.getElementById('scopeTechCount')?.value);
            const complexity = parseFloat(document.getElementById('scopeComplexity')?.value);

            let errors = [];
            if (!type) errors.push("Scope Type is required.");
            if (!duration || duration < 1) errors.push("Duration per Unit must be at least 1.");
            if (!techCount || techCount < 1) errors.push("Required Tech Count must be at least 1.");
            if (!complexity || complexity < 1) errors.push("Complexity Factor must be at least 1.");
            if (scopes.some(s => s.type.toLowerCase() === type.toLowerCase())) errors.push("Scope Type must be unique.");

            if (errors.length > 0) {
                alert("Please fix the following:\n" + errors.join("\n"));
                return;
            }

            const scope = { id: Date.now(), type, duration, techCount, complexity };

            scopes.push(scope);
            updateScopeList();
            clearScopeForm();
            saveAllData();
        }
        function clearScopeForm() {
            if (document.getElementById('scopeType')) document.getElementById('scopeType').value = '';
            if (document.getElementById('scopeDuration')) document.getElementById('scopeDuration').value = '';
            if (document.getElementById('scopeTechCount')) document.getElementById('scopeTechCount').value = '1';
            if (document.getElementById('scopeComplexity')) document.getElementById('scopeComplexity').value = '1';
        }
        function updateScopeList() {
            const list = document.getElementById('scopeList');
            if (!list) return;
            if (scopes.length === 0) {
                list.innerHTML = '<p style="color:#888;">No scope templates defined yet.</p>';
                return;
            }
            list.innerHTML = scopes.map(scope => `
                <div class="scope-type-card">
                    <h5>${scope.type}</h5>
                    <p><strong>Duration:</strong> ${scope.duration} min/unit</p>
                    <p><strong>Tech Required:</strong> ${scope.techCount}</p>
                    <p><strong>Complexity:</strong> ${scope.complexity}x</p>
                    <button class="btn btn-danger" onclick="removeScope(${scope.id})">Remove</button>
                </div>
            `).join('');
        }
        function removeScope(id) {
            scopes = scopes.filter(s => s.id !== id);
            updateScopeList();
            saveAllData();
        }

        // --- Helper: Parse scope string into items ---
        function parseScope(scopeString) {
            const items = [];
            const parts = scopeString.split(',');
            parts.forEach(part => {
                const match = part.trim().match(/(\d+)\s*(.+)/);
                if (match) {
                    const [_, quantity, type] = match;
                    items.push({ quantity: parseInt(quantity), type: type.trim() });
                }
            });
            return items;
        }

        // --- Helper: Calculate job duration based on scope ---
        function calculateJobDuration(scopeString) {
            const scopeItems = parseScope(scopeString);
            let totalDuration = 0;
            scopeItems.forEach(item => {
                const scopeTemplate = scopes.find(s =>
                    item.type.toLowerCase().includes(s.type.toLowerCase()) ||
                    s.type.toLowerCase().includes(item.type.toLowerCase())
                );
                if (scopeTemplate) {
                    totalDuration += item.quantity * scopeTemplate.duration * scopeTemplate.complexity;
                } else {
                    totalDuration += item.quantity * 30; // fallback
                }
            });
            return totalDuration;
        }

        // --- Helper: Calculate driving time and distance using Google Maps Distance Matrix API ---
        async function getDriveInfo(origin, destination) {
            return new Promise((resolve) => {
                if (!origin || !destination) return resolve({minutes: 0, miles: 0});
                if (!window.google || !window.google.maps || !window.google.maps.DistanceMatrixService) return resolve({minutes: 30, miles: 10});
                const service = new google.maps.DistanceMatrixService();
                service.getDistanceMatrix(
                    {
                        origins: [origin],
                        destinations: [destination],
                        travelMode: google.maps.TravelMode.DRIVING,
                        unitSystem: google.maps.UnitSystem.IMPERIAL,
                    },
                    (response, status) => {
                        if (status === "OK" && response.rows[0].elements[0].status === "OK") {
                            const duration = response.rows[0].elements[0].duration.value; // seconds
                            const distance = response.rows[0].elements[0].distance.value; // meters
                            const miles = (distance / 1609.34).toFixed(1);
                            resolve({minutes: Math.round(duration / 60), miles: miles});
                        } else {
                            resolve({minutes: 30, miles: 10});
                        }
                    }
                );
            });
        }

        // --- Helper: Get available days for a location ---
        function getLocationAvailableDays(location) {
            return location.days || [];
        }

        // --- Helper: Get location available time window ---
        function getLocationAvailableTime(location) {
            let startHour = 9, startMin = 0, endHour = 17, endMin = 0;
            if (location.startTime) {
                const [h, m] = location.startTime.split(':');
                startHour = parseInt(h);
                startMin = parseInt(m);
            }
            if (location.endTime) {
                const [h, m] = location.endTime.split(':');
                endHour = parseInt(h);
                endMin = parseInt(m);
            }
            return { startHour, startMin, endHour, endMin };
        }
        
        // --- Helper function to format duration in hours and minutes ---
        function formatDuration(minutes) {
            if (minutes < 60) {
                return `${minutes} minutes`;
            }
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours} hour${hours > 1 ? 's' : ''}${mins > 0 ? `, ${mins} minute${mins > 1 ? 's' : ''}` : ''}`;
        }

        // --- Advanced Scheduling Logic ---
        async function generateSchedule() {
            if (technicians.length === 0 || locations.length === 0) {
                alert('Please add at least one technician team and one location');
                return;
            }
            if (scopes.length === 0) {
                alert('Please define at least one scope template.');
                return;
            }
            if (projectProviders.length === 0) {
                alert('Please select at least one provider for the project.');
                return;
            }
            document.getElementById('scheduleOutput').innerHTML = '<h3>Generating schedule, please wait...</h3>';

            const strategy = document.getElementById('optimizationStrategy')?.value;
            let sortedLocations = [...locations];
            if (strategy === 'priority') {
                const priorityOrder = { 'High': 1, 'Medium': 2, 'Low': 3 };
                sortedLocations.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
            }
            const schedule = {};
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            const installWindowStart = document.getElementById('installWindowStart')?.value;
            const installWindowEnd = document.getElementById('installWindowEnd')?.value;
            const windowStart = installWindowStart ? new Date(installWindowStart + "T00:00:00") : null;
            const windowEnd = installWindowEnd ? new Date(installWindowEnd + "T23:59:59") : null;

            const driveInfoCache = {};
            async function getDriveInfoCached(origin, destination) {
                const key = `${origin}|${destination}`;
                if (driveInfoCache[key] !== undefined) return driveInfoCache[key];
                const info = await getDriveInfo(origin, destination);
                driveInfoCache[key] = info;
                return info;
            }

            const techUsage = {};
            technicians.forEach(tech => {
                techUsage[tech.id] = {};
            });
            
            let currentDate = new Date(installWindowStart + "T00:00:00");
            if (!installWindowStart) {
                currentDate = new Date();
                currentDate.setHours(0,0,0,0);
            }

            let locationsToRetry = sortedLocations.map(loc => ({ ...loc, remainingDuration: calculateJobDuration(loc.scope), originalScope: loc.scope }));
            let unassignedLocations = [];

            const maxDays = 365;
            let loopGuard = 0;

            while (locationsToRetry.length > 0 && loopGuard < maxDays) {
                loopGuard++;
                const dayOfWeek = days[currentDate.getDay()];
                let didScheduleThisDay = false;

                const currentDayQueue = [...locationsToRetry];
                locationsToRetry.length = 0; // Clear the retry queue for a fresh start

                for (const location of currentDayQueue) {
                    const { startHour: locStartHour, startMin: locStartMin, endHour: locEndHour, endMin: locEndMin } = getLocationAvailableTime(location);
                    const isLocationAvailable = getLocationAvailableDays(location).includes(dayOfWeek);

                    let scheduledThisLocation = false;

                    if (isLocationAvailable && (!windowEnd || currentDate <= windowEnd)) {
                        const eligibleTeams = technicians.filter(tech => {
                            const hasProviderMatch = (projectProviders || []).every(provider => (tech.providers || []).includes(provider));
                            return (tech.days || []).includes(dayOfWeek) && (tech.count - (techUsage[tech.id][currentDate.toISOString().split('T')[0]] || 0)) > 0 && hasProviderMatch;
                        });

                        if (eligibleTeams.length > 0) {
                            const scopeItems = parseScope(location.originalScope);
                            let requiredTechs = 0;
                            scopeItems.forEach(item => {
                                const scopeTemplate = scopes.find(s => s.type.toLowerCase().includes(item.type.toLowerCase()));
                                if (scopeTemplate) {
                                    requiredTechs = Math.max(requiredTechs, scopeTemplate.techCount);
                                }
                            });

                            eligibleTeams.sort((a, b) => (b.count - (techUsage[b.id][currentDate.toISOString().split('T')[0]] || 0)) - (a.count - (techUsage[a.id][currentDate.toISOString().split('T')[0]] || 0)));

                            let assignedTeams = [];
                            let assignedTechCount = 0;
                            let primaryTeamDriveInfo = null;

                            for(const team of eligibleTeams) {
                                const availableTechsInTeam = team.count - (techUsage[team.id][currentDate.toISOString().split('T')[0]] || 0);
                                if(availableTechsInTeam <= 0) continue;

                                const techsToAssign = Math.min(availableTechsInTeam, requiredTechs - assignedTechCount);
                                
                                if (techsToAssign > 0) {
                                    if (!primaryTeamDriveInfo) {
                                        primaryTeamDriveInfo = await getDriveInfoCached(team.address, location.address);
                                    }
                                    assignedTeams.push({
                                        teamId: team.id,
                                        teamName: team.teamName,
                                        assignedTechs: techsToAssign,
                                        driveInfo: await getDriveInfoCached(team.address, location.address)
                                    });
                                    assignedTechCount += techsToAssign;
                                    if (assignedTechCount >= requiredTechs) break;
                                }
                            }

                            if (assignedTechCount >= requiredTechs && primaryTeamDriveInfo) {
                                const teamStart = eligibleTeams[0].startTime.split(':');
                                const teamEnd = eligibleTeams[0].endTime.split(':');
                                const dayStartTime = new Date(currentDate);
                                dayStartTime.setHours(Math.max(parseInt(teamStart[0]), locStartHour), Math.max(parseInt(teamStart[1]), locStartMin), 0, 0);
                                const dayEndTime = new Date(currentDate);
                                dayEndTime.setHours(Math.min(parseInt(teamEnd[0]), locEndHour), Math.min(parseInt(teamEnd[1]), locEndMin), 0, 0);

                                const availableWorkMinutes = (dayEndTime.getTime() - dayStartTime.getTime()) / 60000;
                                
                                const workToday = Math.min(location.remainingDuration, availableWorkMinutes);

                                const jobStartTime = new Date(dayStartTime);
                                const jobEndTime = new Date(jobStartTime.getTime() + workToday * 60000);
                                
                                const newAssignment = {
                                    location: location,
                                    startDateTime: jobStartTime,
                                    endDateTime: jobEndTime,
                                    duration: workToday,
                                    driveTime: primaryTeamDriveInfo.minutes,
                                    driveMiles: primaryTeamDriveInfo.miles,
                                    assignedTeams: assignedTeams,
                                    day: dayOfWeek,
                                    overrideParams: [],
                                    requiredTechs: requiredTechs,
                                    id: Date.now()
                                };

                                if (!schedule[currentDate.toISOString()]) schedule[currentDate.toISOString()] = { date: currentDate, teams: [] };
                                
                                for(const assignedTeam of assignedTeams) {
                                    let teamEntry = schedule[currentDate.toISOString()].teams.find(t => t.team.id === assignedTeam.teamId);
                                    if (!teamEntry) {
                                        const originalTeam = technicians.find(t => t.id === assignedTeam.teamId);
                                        teamEntry = { team: originalTeam, assignments: [] };
                                        schedule[currentDate.toISOString()].teams.push(teamEntry);
                                    }
                                    teamEntry.assignments.push(newAssignment);
                                    techUsage[assignedTeam.teamId][currentDate.toISOString().split('T')[0]] = (techUsage[assignedTeam.teamId][currentDate.toISOString().split('T')[0]] || 0) + assignedTeam.assignedTechs;
                                }
                                
                                location.remainingDuration -= workToday;

                                if (location.remainingDuration <= 0) {
                                    scheduledThisLocation = true;
                                    didScheduleThisDay = true;
                                } else {
                                    locationsToRetry.push(location);
                                    scheduledThisLocation = true;
                                    didScheduleThisDay = true;
                                }
                            }
                        }
                    }
                    if (!scheduledThisLocation) {
                        locationsToRetry.push(location);
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            unassignedLocations = locationsToRetry.filter(loc => loc.remainingDuration > 0);
            
            // Clean up temporary properties before saving
            locations.forEach(loc => {
                delete loc.remainingDuration;
                delete loc.originalScope;
            });
            
            // Restore original scope for all locations for display
            unassignedLocations = unassignedLocations.map(loc => {
                if (loc.originalScope) {
                    loc.scope = loc.originalScope;
                    delete loc.originalScope;
                }
                return loc;
            });
            
            lastUnassignedLocations = unassignedLocations;
            lastSchedule = schedule;
            
            saveAllData();
            saveScheduleState();
            displaySchedule(schedule, unassignedLocations, false);
            displayMetrics(schedule, unassignedLocations);
        }

        async function overrideUnassignedSchedule() {
            if (!lastUnassignedLocations || lastUnassignedLocations.length === 0) {
                alert('No unassigned locations to override.');
                return;
            }
            document.getElementById('scheduleOutput').innerHTML = '<h3>Overriding parameters for unassigned locations...</h3>';

            const installWindowStart = document.getElementById('installWindowStart')?.value;
            const installWindowEnd = document.getElementById('installWindowEnd')?.value;
            let windowStart = installWindowStart ? new Date(installWindowStart + "T00:00:00") : null;
            let windowEnd = installWindowEnd ? new Date(installWindowEnd + "T23:59:59") : null;

            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const driveInfoCache = {};
            async function getDriveInfoCached(origin, destination) {
                const key = `${origin}|${destination}`;
                if (driveInfoCache[key] !== undefined) return driveInfoCache[key];
                const info = await getDriveInfo(origin, destination);
                driveInfoCache[key] = info;
                return info;
            }

            const techUsage = {};
            technicians.forEach(tech => {
                techUsage[tech.id] = {};
            });

            let unassignedCopy = lastUnassignedLocations.map(loc => ({ ...loc, remainingDuration: calculateJobDuration(loc.scope) }));
            lastUnassignedLocations = [];
            
            let currentDate = new Date();
            currentDate.setHours(0,0,0,0);
            let loopGuard = 0;

            let schedule = JSON.parse(JSON.stringify(lastSchedule)); // Deep copy

            while (unassignedCopy.length > 0 && loopGuard < 1000) {
                loopGuard++;
                const dayOfWeek = days[currentDate.getDay()];
                const locationsToProcessThisDay = [...unassignedCopy];
                let didScheduleThisDay = false;

                for (let i = 0; i < locationsToProcessThisDay.length; i++) {
                    const location = locationsToProcessThisDay[i];
                    
                    let jobDurationMinutes = location.remainingDuration;
                    let scheduledThisLocation = false;
                    
                    const isLocationAvailable = getLocationAvailableDays(location).includes(dayOfWeek);

                    if (isLocationAvailable && (!windowStart || currentDate >= windowStart) && (!windowEnd || currentDate <= windowEnd)) {
                        
                        const eligibleTeams = technicians.filter(team => (team.count - (techUsage[team.id][currentDate.toISOString().split('T')[0]] || 0)) > 0);
                        if (eligibleTeams.length === 0) {
                            continue;
                        }
                        
                        const scopeItems = parseScope(location.scope);
                        let requiredTechs = 0;
                        scopeItems.forEach(item => {
                            const scopeTemplate = scopes.find(s => s.type.toLowerCase().includes(item.type.toLowerCase()));
                            if (scopeTemplate) {
                                requiredTechs = Math.max(requiredTechs, scopeTemplate.techCount);
                            }
                        });

                        eligibleTeams.sort((a, b) => (b.count - (techUsage[b.id][currentDate.toISOString().split('T')[0]] || 0)) - (a.count - (techUsage[a.id][currentDate.toISOString().split('T')[0]] || 0)));

                        let assignedTeams = [];
                        let assignedTechCount = 0;
                        let primaryTeamDriveInfo = null;
                        let paramsBroken = [];
                        
                        for(const team of eligibleTeams) {
                            const availableTechsInTeam = team.count - (techUsage[team.id][currentDate.toISOString().split('T')[0]] || 0);
                            if(availableTechsInTeam <= 0) continue;

                            const techsToAssign = Math.min(availableTechsInTeam, requiredTechs - assignedTechCount);

                            if(techsToAssign > 0) {
                                const hasProviderMatch = (projectProviders || []).every(provider => (team.providers || []).includes(provider));
                                if (!hasProviderMatch) {
                                    paramsBroken.push("Provider Certification");
                                }
                                if (!(team.days || []).includes(dayOfWeek)) {
                                    paramsBroken.push("Team Availability");
                                }

                                if (!primaryTeamDriveInfo) {
                                    primaryTeamDriveInfo = await getDriveInfoCached(team.address, location.address);
                                }
                                assignedTeams.push({
                                    teamId: team.id,
                                    teamName: team.teamName,
                                    assignedTechs: techsToAssign,
                                    driveInfo: await getDriveInfoCached(team.address, location.address)
                                });
                                assignedTechCount += techsToAssign;
                                if (assignedTechCount >= requiredTechs) break;
                            }
                        }

                        if (assignedTechCount >= requiredTechs && primaryTeamDriveInfo) {
                            const { startHour: locStartHour, startMin: locStartMin, endHour: locEndHour, endMin: locEndMin } = getLocationAvailableTime(location);
                            const teamStart = eligibleTeams[0].startTime.split(':');
                            const teamEnd = eligibleTeams[0].endTime.split(':');
                            const dayStartTime = new Date(currentDate);
                            dayStartTime.setHours(Math.max(parseInt(teamStart[0]), locStartHour), Math.max(parseInt(teamStart[1]), locStartMin), 0, 0);
                            const dayEndTime = new Date(currentDate);
                            dayEndTime.setHours(Math.min(parseInt(teamEnd[0]), locEndHour), Math.min(parseInt(teamEnd[1]), locEndMin), 0, 0);

                            const availableWorkMinutes = (dayEndTime.getTime() - dayStartTime.getTime()) / 60000;
                            if (availableWorkMinutes <= 0) {
                                continue;
                            }

                            const workToday = Math.min(jobDurationMinutes, availableWorkMinutes);
                            const jobStartTime = new Date(dayStartTime);
                            const jobEndTime = new Date(jobStartTime.getTime() + workToday * 60000);

                            if ((windowStart && jobStartTime < windowStart) || (windowEnd && jobEndTime > windowEnd)) {
                                paramsBroken.push("Install Window");
                            }
                            
                            let newAssignment = {
                                location: { ...location, scope: location.originalScope || location.scope },
                                startDateTime: jobStartTime,
                                endDateTime: jobEndTime,
                                duration: workToday,
                                driveTime: primaryTeamDriveInfo.minutes,
                                driveMiles: primaryTeamDriveInfo.miles,
                                assignedTeams: assignedTeams,
                                day: dayOfWeek,
                                overrideParams: [...new Set(paramsBroken)],
                                requiredTechs: requiredTechs,
                                id: Date.now()
                            };

                            if (!schedule[currentDate.toISOString()]) schedule[currentDate.toISOString()] = { date: currentDate, teams: [] };
                            
                            for(const assignedTeam of assignedTeams) {
                                let teamEntry = schedule[currentDate.toISOString()].teams.find(t => t.team.id === assignedTeam.teamId);
                                if (!teamEntry) {
                                    const originalTeam = technicians.find(t => t.id === assignedTeam.teamId);
                                    teamEntry = { team: originalTeam, assignments: [] };
                                    schedule[currentDate.toISOString()].teams.push(teamEntry);
                                }
                                teamEntry.assignments.push(newAssignment);
                                techUsage[assignedTeam.teamId][currentDate.toISOString().split('T')[0]] = (techUsage[assignedTeam.teamId][currentDate.toISOString().split('T')[0]] || 0) + assignedTeam.assignedTechs;
                            }

                            if (jobDurationMinutes - workToday <= 0) {
                                scheduledThisLocation = true;
                                didScheduleThisDay = true;
                            } else {
                                location.originalScope = location.originalScope || location.scope;
                                location.scope = `${jobDurationMinutes - workToday} min remaining`;
                                scheduledThisLocation = true;
                                didScheduleThisDay = true;
                            }
                        }
                    }
                    if (scheduledThisLocation) {
                        const originalIndex = unassignedCopy.findIndex(l => l.id === location.id);
                        if (originalIndex > -1) {
                            unassignedCopy.splice(originalIndex, 1);
                        }
                        if (location.scope.includes('min remaining')) {
                            unassignedCopy.push(location);
                        }
                    }
                }
                if (!didScheduleThisDay && unassignedCopy.length > 0) {
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            lastUnassignedLocations = unassignedCopy;
            lastSchedule = schedule;
            
            // Restore original scope before saving
            locations.forEach(loc => {
                if (loc.originalScope) {
                    loc.scope = loc.originalScope;
                    delete loc.originalScope;
                }
            });

            saveScheduleState();
            displaySchedule(schedule, lastUnassignedLocations, true);
            displayMetrics(schedule, lastUnassignedLocations);
        }

        function displaySchedule(schedule, unassigned, overrideMode = false) {
            const output = document.getElementById('scheduleOutput');
            let html = '<h3>📅 Optimized Installation Schedule</h3>';

            if (Object.keys(schedule).length === 0) {
                output.innerHTML = '<h3>No schedule generated.</h3>';
                return;
            }

            const sortedDays = Object.keys(schedule).sort((a, b) => new Date(a).getTime() - new Date(b).getTime());

            sortedDays.forEach(dayKey => {
                const dayObj = schedule[dayKey];
                let { date, teams } = dayObj;
                
                if (teams.length > 0) {
                    html += `<div class="schedule-day">`;
                    html += `<h4>${date instanceof Date ? date.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' }) : dayKey}</h4>`;
                    
                    const assignmentsByLocation = {};
                    teams.forEach(teamSchedule => {
                        teamSchedule.assignments.forEach(assignment => {
                            const locationId = assignment.location.id;
                            const assignmentKey = `${locationId}-${assignment.startDateTime.getTime()}`;
                            if (!assignmentsByLocation[assignmentKey]) {
                                assignmentsByLocation[assignmentKey] = {
                                    ...assignment,
                                    teams: []
                                };
                            }
                            assignment.assignedTeams.forEach(team => {
                                const existingTeam = assignmentsByLocation[assignmentKey].teams.find(t => t.teamId === team.teamId);
                                if (!existingTeam) {
                                    assignmentsByLocation[assignmentKey].teams.push(team);
                                }
                            });
                        });
                    });

                    Object.values(assignmentsByLocation).forEach(assignment => {
                        html += `<div class="assignment">`;
                        
                        const startTime = assignment.startDateTime instanceof Date && !isNaN(assignment.startDateTime) ? assignment.startDateTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }) : assignment.startDateTime;
                        const endTime = assignment.endDateTime instanceof Date && !isNaN(assignment.endDateTime) ? assignment.endDateTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }) : assignment.endDateTime;
                        
                        html += `<p>
                            <span class="tech-tag">${startTime}</span> - <span class="tech-tag">${endTime}</span>
                            <span class="location-tag">${assignment.location.siteId}</span>
                        </p>`;
                        
                        html += `<p style="margin-top: 5px;"><strong>Assigned Teams:</strong></p>`;
                        html += `<ul>`;
                        const uniqueTeams = assignment.assignedTeams.filter((v, i, a) => a.findIndex(t => t.teamId === v.teamId) === i);
                        uniqueTeams.forEach(team => {
                            const originalTeam = technicians.find(t => t.id === team.teamId);
                            const teamName = originalTeam ? originalTeam.teamName : `Team ID: ${team.teamId}`;
                            html += `<li style="margin-left: 20px;">${teamName} - ${team.assignedTechs} tech${team.assignedTechs > 1 ? 's' : ''}</li>`;
                        });
                        html += `</ul>`;
                        
                        html += `<p style="margin-top: 5px;">📍 ${assignment.location.address}</p>`;
                        html += `<p>📋 ${assignment.location.scope}</p>`;
                        html += `<p>⏱️ Est. Duration: ${formatDuration(assignment.duration)}</p>`;
                        html += `<p>🔌 Providers: ${(projectProviders || []).join(', ') || 'None'}</p>`;
                        
                        if (assignment.assignedTeams.length > 0) {
                            const primaryTeam = assignment.assignedTeams[0];
                            const originalPrimaryTeam = technicians.find(t => t.id === primaryTeam.teamId);
                            if (originalPrimaryTeam) {
                                html += `<p>🚗 Est. Drive from ${originalPrimaryTeam.teamName}: ${primaryTeam.driveInfo.miles} mi, ${primaryTeam.driveInfo.minutes} min</p>`;
                            }
                        }
                        
                        if (assignment.overrideParams && assignment.overrideParams.length > 0) {
                            html += `<p style="color:#c33;"><strong>Override: </strong>Scheduled by breaking: ${assignment.overrideParams.join(', ')}</p>`;
                        }
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                }
            });
            if (!overrideMode && unassigned.length > 0) {
                html += `<div class="error">`;
                html += `<h4>⚠️ Unassigned Locations (${unassigned.length})</h4>`;
                unassigned.forEach(loc => {
                    html += `<p>• ${loc.siteId} - ${loc.address} (${loc.scope})</p>`;
                });
                html += `<p><strong>Reasons may include: insufficient techs, missing provider/certification, or site not available that day.</strong></p>`;
                html += `<p><strong>Consider adding more technician teams, updating certifications, or extending working hours.</strong></p>`;
                html += `<button class="btn btn-secondary" id="overrideBtn" onclick="overrideUnassignedSchedule()" style="margin-top:10px;">Override Parameters for Unassigned</button>`;
                html += `</div>`;
            } else if(overrideMode && unassigned.length > 0) {
                html += `<div class="error">`;
                html += `<h4>⚠️ Still Unassigned Locations (${unassigned.length})</h4>`;
                unassigned.forEach(loc => {
                    html += `<p>• ${loc.siteId} - ${loc.address} (${loc.scope})</p>`;
                });
                html += `<p><strong>Even with relaxed parameters, these locations could not be scheduled.</strong></p>`;
                html += `</div>`;
            }
            output.innerHTML = html;
        }

        // --- Metrics Display ---
        function displayMetrics(schedule, unassigned) {
            const metricsDiv = document.getElementById('metrics');
            if (!metricsDiv) return;

            let totalJobs = 0;
            let totalDriveMinutes = 0;
            let totalDriveMiles = 0;
            let totalDuration = 0;
            let totalTeams = 0;

            const countedJobs = new Set();
            const countedTeams = new Set();
            
            if (schedule && typeof schedule === 'object') {
                Object.values(schedule).forEach(dayObj => {
                    if (dayObj.teams) {
                        dayObj.teams.forEach(teamSchedule => {
                            countedTeams.add(teamSchedule.team.id);
                            teamSchedule.assignments.forEach(a => {
                                const jobId = `${a.location.id}-${a.startDateTime.getTime()}`;
                                if (!countedJobs.has(jobId)) {
                                    totalJobs++;
                                    totalDriveMinutes += Number(a.driveTime) || 0;
                                    totalDriveMiles += Number(a.driveMiles) || 0;
                                    totalDuration += Number(a.duration) || 0;
                                    countedJobs.add(jobId);
                                }
                            });
                        });
                    }
                });
            }
            totalTeams = countedTeams.size;

            metricsDiv.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${totalJobs}</div>
                    <div class="metric-label">Total Jobs Scheduled</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${totalTeams}</div>
                    <div class="metric-label">Teams Utilized</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${totalDriveMiles.toFixed(1)}</div>
                    <div class="metric-label">Total Drive Miles</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${totalDriveMinutes}</div>
                    <div class="metric-label">Total Drive Minutes</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${totalDuration}</div>
                    <div class="metric-label">Total Installation Minutes</div>
                </div>
                ${unassigned && unassigned.length > 0 ? `
                <div class="metric-card" style="background: #dc3545;">
                    <div class="metric-value">${unassigned.length}</div>
                    <div class="metric-label">Unassigned Locations</div>
                </div>
                ` : ''}
            `;

            const overrideBtn = document.getElementById('overrideBtn');
            if (overrideBtn) {
                overrideBtn.style.display = unassigned.length > 0 ? 'inline-block' : 'none';
            }
        }

        // --- Export to XLSX Functionality ---
        function exportToXLSX() {
            if (Object.keys(lastSchedule).length === 0) {
                alert("Please generate a schedule before exporting.");
                return;
            }

            const data = [];
            let sheetName = "Schedule";
            let filename = "schedule.xlsx";

            const header = [
                "Date",
                "Team Name",
                "Team Size",
                "Assigned Techs",
                "Start Time",
                "End Time",
                "Site ID",
                "Address",
                "Scope of Work",
                "Providers",
                "Duration (min)",
                "Drive Time (min)",
                "Drive Distance (mi)",
                "Override Reasons"
            ];
            data.push(header);

            const allAssignments = [];
            Object.values(lastSchedule).forEach(dayObj => {
                const assignmentsByLocation = {};
                dayObj.teams.forEach(teamSchedule => {
                    teamSchedule.assignments.forEach(assignment => {
                        const locationId = assignment.location.id;
                        const assignmentKey = `${locationId}-${assignment.startDateTime.getTime()}`;
                        if (!assignmentsByLocation[assignmentKey]) {
                            assignmentsByLocation[assignmentKey] = {
                                ...assignment,
                                assignedTeams: []
                            };
                        }
                        assignment.assignedTeams.forEach(team => {
                            const existingTeam = assignmentsByLocation[assignmentKey].assignedTeams.find(t => t.teamId === team.teamId);
                            if (!existingTeam) {
                                assignmentsByLocation[assignmentKey].assignedTeams.push(team);
                            }
                        });
                    });
                });
                allAssignments.push(...Object.values(assignmentsByLocation));
            });

            allAssignments.sort((a,b) => a.startDateTime.getTime() - b.startDateTime.getTime());

            allAssignments.forEach(assignment => {
                const uniqueTeams = assignment.assignedTeams.filter((v, i, a) => a.findIndex(t => t.teamId === v.teamId) === i);
                uniqueTeams.forEach(teamData => {
                    const originalTeam = technicians.find(t => t.id === teamData.teamId);
                    const teamName = originalTeam ? originalTeam.teamName : `Team ID: ${teamData.teamId}`;

                    const row = [
                        new Date(assignment.startDateTime).toLocaleDateString(),
                        teamName,
                        originalTeam ? originalTeam.count : 'N/A',
                        teamData.assignedTechs,
                        new Date(assignment.startDateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }),
                        new Date(assignment.endDateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }),
                        assignment.location.siteId,
                        assignment.location.address,
                        assignment.location.scope,
                        (projectProviders || []).join(', '),
                        assignment.duration,
                        teamData.driveInfo.minutes,
                        teamData.driveInfo.miles,
                        (assignment.overrideParams || []).join(', ')
                    ];
                    data.push(row);
                });
            });

            if (lastUnassignedLocations.length > 0) {
                 const unassignedHeader = ["Unassigned Locations", "", "", "", "", "", "", "", "", "", "", "", "", ""];
                 data.push([]);
                 data.push(unassignedHeader);
                 lastUnassignedLocations.forEach(loc => {
                     data.push([
                         "",
                         "",
                         "",
                         "",
                         "",
                         "",
                         "",
                         loc.siteId,
                         loc.address,
                         loc.scope,
                         (projectProviders || []).join(', '),
                         "",
                         "",
                         ""
                     ]);
                 });
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, filename);
        }

    </script>
</body>
</html>
