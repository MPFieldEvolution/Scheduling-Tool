<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>FE Installation Project Scheduler</title>
Â  Â  <style>
Â  Â  Â  Â  * { margin: 0; padding: 0; box-sizing: border-box; }
Â  Â  Â  Â  body { font-family: Arial, Helvetica, sans-serif; background: #ff0000; min-height: 100vh; padding: 20px; }
Â  Â  Â  Â  .container { max-width: 1400px; margin: 0 auto; background: rgba(255,255,255,0.95); border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);}
Â  Â  Â  Â  h1 { color: #ff0000; margin-bottom: 30px; text-align: center; font-size: 2.5em; font-family: Arial, Helvetica, sans-serif; background: none; -webkit-background-clip: unset; background-clip: unset; -webkit-text-fill-color: unset;}
Â  Â  Â  Â  .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e0e0e0;}
Â  Â  Â  Â  .tab { padding: 12px 24px; background: none; border: none; cursor: pointer; font-size: 16px; color: #666; transition: all 0.3s; border-bottom: 3px solid transparent; margin-bottom: -2px;}
Â  Â  Â  Â  .tab.active { color: #ff0000; border-bottom-color: #ff0000; font-weight: 600;}
Â  Â  Â  Â  .tab:hover { color: #ff0000;}
Â  Â  Â  Â  .section { display: none; animation: fadeIn 0.5s;}
Â  Â  Â  Â  .section.active { display: block;}
Â  Â  Â  Â  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);}}
Â  Â  Â  Â  .form-grid { display: grid; grid-template-columns: repeat(auto-fit, min-content); grid-auto-rows: min-content; gap: 20px; margin-bottom: 20px;}
Â  Â  Â  Â  .form-group { display: flex; flex-direction: column;}
Â  Â  Â  Â  label { font-weight: 600; color: #555; margin-bottom: 8px; font-size: 14px;}
Â  Â  Â  Â  input, select, textarea { padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; transition: all 0.3s;}
Â  Â  Â  Â  input:focus, select:focus, textarea:focus { outline: none; border-color: #ff0000; box-shadow: 0 0 0 3px rgba(255,0,0,0.1);}
Â  Â  Â  Â  textarea { resize: vertical; min-height: 100px;}
Â  Â  Â  Â  .btn { padding: 12px 24px; background: linear-gradient(135deg, #ff0000, #b30000); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255,0,0,0.3);}
Â  Â  Â  Â  .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,0,0,0.4);}
Â  Â  Â  Â  .btn-secondary { background: #6c757d; box-shadow: 0 4px 15px rgba(108,117,125,0.3);}
Â  Â  Â  Â  .btn-danger { background: #dc3545; box-shadow: 0 4-px 15px rgba(220,53,69,0.3);}
Â  Â  Â  Â  .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s;}
Â  Â  Â  Â  .card:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.15);}
Â  Â  Â  Â  .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;}
Â  Â  Â  Â  .card-title { font-size: 18px; font-weight: 600; color: #333;}
Â  Â  Â  Â  .list-container { max-height: 500px; overflow-y: auto;}
Â  Â  Â  Â  .schedule-output { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-top: 20px; min-height: 200px;}
Â  Â  Â  Â  .schedule-day { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #ff0000;}
Â  Â  Â  Â  .schedule-day h4 { color: #ff0000; margin-bottom: 10px;}
Â  Â  Â  Â  .assignment { background: #fff0f0; padding: 10px; border-radius: 6px; margin-bottom: 8px;}
Â  Â  Â  Â  .tech-tag { display: inline-block; background: #ff0000; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px;}
Â  Â  Â  Â  .location-tag { display: inline-block; background: #b30000; color: white; padding: 4px 8px; border-radius: 4-px; font-size: 12px;}
Â  Â  Â  Â  .scope-types { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;}
Â  Â  Â  Â  .scope-type-card { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #e0e0e0;}
Â  Â  Â  Â  .scope-type-card h5 { color: #ff0000; margin-bottom: 10px;}
Â  Â  Â  Â  .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;}
Â  Â  Â  Â  .metric-card { background: linear-gradient(135deg, #ff0000, #b30000); color: white; padding: 20px; border-radius: 12px; text-align: center;}
Â  Â  Â  Â  .metric-value { font-size: 32px; font-weight: bold; margin-bottom: 5px;}
Â  Â  Â  Â  .metric-label { font-size: 14px; opacity: 0.9;}
Â  Â  Â  Â  .error { background: #fee; color: #c33; padding: 10px; border-radius: 6px; margin-top: 10px;}
Â  Â  Â  Â  .success { background: #efe; color: #3c3; padding: 10px; border-radius: 6px; margin-top: 10px;}
Â  Â  Â  Â  .project-list-container {
Â  Â  Â  Â  Â  Â  max-height: 250px;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .project-item {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  Â  Â  }
Â  Â  Â  Â  .project-item:hover {
Â  Â  Â  Â  Â  Â  background-color: #f8f8f8;
Â  Â  Â  Â  }
Â  Â  </style>
Â  Â  Â  Â  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
Â  Â  Â  Â  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY_HERE&libraries=places&callback=initMap" defer></script>
</head>
<body>
Â  Â  <div class="container">
Â  Â  Â  Â  <h1>FE Installation Project Scheduler</h1>
Â  Â  Â  Â  <div class="tabs">
Â  Â  Â  Â  Â  Â  <button class="tab active" type="button" data-tab="technicians">Technicians</button>
Â  Â  Â  Â  Â  Â  <button class="tab" type="button" data-tab="locations">Locations</button>
Â  Â  Â  Â  Â  Â  <button class="tab" type="button" data-tab="scopes">Scope Templates</button>
Â  Â  Â  Â  Â  Â  <button class="tab" type="button" data-tab="schedule">Generate Schedule</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="technicians" class="section active">
Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="card-title">Add Technician Team</h3>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="techLocation">Base Location</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="techLocation" name="techLocation" placeholder="e.g., Downtown Hub">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="techAddress">Technician Address</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="techAddress" name="techAddress" placeholder="e.g., 100 Main St, City, State ZIP" autocomplete="off" style="width:100%;" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="techCount">Number of Technicians</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="techCount" name="techCount" min="1" value="1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="techTeamName">Team Name/ID</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="techTeamName" name="techTeamName" placeholder="e.g., Team Alpha">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Availability (Days)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="techDaysCheckboxes" style="display: flex; flex-wrap: wrap; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="techDayMonday"><input type="checkbox" id="techDayMonday" name="techDay" value="Monday" checked> Monday</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="techDayTuesday"><input type="checkbox" id="techDayTuesday" name="techDay" value="Tuesday" checked> Tuesday</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="techDayWednesday"><input type="checkbox" id="techDayWednesday" name="techDay" value="Wednesday" checked> Wednesday</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="techDayThursday"><input type="checkbox" id="techDayThursday" name="techDay" value="Thursday" checked> Thursday</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="techDayFriday"><input type="checkbox" id="techDayFriday" name="techDay" value="Friday" checked> Friday</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="techDaySaturday"><input type="checkbox" id="techDaySaturday" name="techDay" value="Saturday"> Saturday</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="techDaySunday"><input type="checkbox" id="techDaySunday" name="techDay" value="Sunday"> Sunday</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="techStartTime">Working Hours</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="techStartTime" name="techStartTime" value="08:00">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="techEndTime" name="techEndTime" value="17:00">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="techSpecializations">Providers (Certifications)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="techProviderCheckboxes" style="display: flex; flex-wrap: wrap; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" id="addTechBtn" onclick="addTechnician()">Add Technician Team</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="card-title">Current Technician Teams</h3>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="technicianList" class="list-container"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="card-title">Import Technician Data from CSV</h3>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <p style="margin-bottom: 10px; font-size: 14px; color: #555;">Paste comma-separated data below. Format: `Team Name,Base Location,Technician Address,Number of Technicians,Availability(Mon;Tue;...),Working Hours(08:00-17:00),Providers(Motive;Lytx;...)`</p>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="csvData" name="csvData" rows="5" placeholder="Paste your CSV data here..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" style="margin-top: 10px;" onclick="importTechnicians()">Load Technicians</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="locations" class="section">
Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="card-title">Project Providers (Applies to all locations)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="projectProviderCheckboxes" style="display: flex; flex-wrap: wrap; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="card-title">Add Installation Location</h3>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locationId">Site ID</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="locationId" name="locationId" placeholder="e.g., SITE-001">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locationName">Site Name</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="locationName" name="locationName" placeholder="e.g., Main Street Branch">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locationAddress">Full Address</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="locationAddress" name="locationAddress" placeholder="123 Main St, City, State ZIP" autocomplete="off" style="width:100%;" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locationScope">Scope of Work</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="locationScope" name="locationScope" placeholder="e.g., 15 VG + DCs, 5 PAs">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locationPriority">Priority Level</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="locationPriority" name="locationPriority">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="High">High</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Medium" selected>Medium</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Low">Low</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Site Availability (Days)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="locationDayCheckboxes" style="display: flex; flex-wrap: wrap; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locDayMonday"><input type="checkbox" id="locDayMonday" name="locDay" value="Monday" checked> Monday</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locDayTuesday"><input type="checkbox" id="locDayTuesday" name="locDay" value="Tuesday" checked> Tuesday</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locDayWednesday"><input type="checkbox" id="locDayWednesday" name="locDay" value="Wednesday" checked> Wednesday</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locDayThursday"><input type="checkbox" id="locDayThursday" name="locDay" value="Thursday" checked> Thursday</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locDayFriday"><input type="checkbox" id="locDayFriday" name="locDay" value="Friday" checked> Friday</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locDaySaturday"><input type="checkbox" id="locDaySaturday" name="locDay" value="Saturday"> Saturday</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locDaySunday"><input type="checkbox" id="locDaySunday" name="locDay" value="Sunday"> Sunday</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locationStartTime">Site Hours</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="locationStartTime" name="locationStartTime" value="09:00">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="locationEndTime" name="locationEndTime" value="17:00">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locationContact">Contact Person</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="locationContact" name="locationContact" placeholder="Name and phone">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="locationNotes">Special Requirements</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="locationNotes" name="locationNotes" placeholder="Access codes, parking info, etc."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="addLocation()">Add Location</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="card-title">Current Locations</h3>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="locationList" class="list-container"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="scopes" class="section">
Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="card-title">Define Scope Templates</h3>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="scopeType">Scope Type</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="scopeType" name="scopeType" placeholder="e.g., VG, DC, PA">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="scopeDuration">Duration per Unit (minutes)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="scopeDuration" name="scopeDuration" min="1" placeholder="e.g., 30">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="scopeTechCount">Required Tech Count</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="scopeTechCount" name="scopeTechCount" min="1" value="1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="scopeComplexity">Complexity Factor</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="scopeComplexity" name="scopeComplexity">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="1">Simple (1x)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="1.5">Moderate (1.5x)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="2">Complex (2x)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="addScope()">Add Scope Template</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="card-title">Current Scope Templates</h3>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="scopeList" class="scope-types"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="schedule" class="section">
Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="card-title">Schedule Parameters</h3>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="display:none">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="driveTime">Average Drive Time (minutes)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="driveTime" name="driveTime" value="30" min="0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="optimizationStrategy">Optimization Strategy</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="optimizationStrategy" name="optimizationStrategy">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="efficiency">Maximum Efficiency</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="priority">Priority First</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="balanced">Balanced Approach</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="installWindowStart">Install Window Start</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="installWindowStart" name="installWindowStart" value="">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="installWindowEnd">Install Window End</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="installWindowEnd" name="installWindowEnd" value="">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="color:#888; font-size:13px; margin-bottom:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <em>Drive time is now automatically estimated based on technician and location addresses.<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Buffer time is now always automated (minimum 15 minutes before each job).</em>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="generateSchedule()">ðŸš€ Generate Optimal Schedule</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-secondary" id="overrideBtn" onclick="overrideUnassignedSchedule()" style="margin-left:10px; display:none;">Override Parameters</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" onclick="exportToXLSX()" style="margin-left: 10px;">Export to XLSX</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="metrics" id="metrics"></div>
Â  Â  Â  Â  Â  Â  <div class="schedule-output" id="scheduleOutput">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Generated Schedule will appear here...</h3>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <script>
Â  Â  Â  Â  // --- Data and UI Logic ---
Â  Â  Â  Â  let technicians = [];
Â  Â  Â  Â  let locations = [];
Â  Â  Â  Â  let scopes = [];
Â  Â  Â  Â  let projectProviders = [];
Â  Â  Â  Â  let editTechId = null;
Â  Â  Â  Â  let editLocationId = null;
Â  Â  Â  Â  const providers = ["Motive", "Lytx", "Samsara", "Verizon Connect", "Vestige", "LinxUp"];

Â  Â  Â  Â  // Add a global to store last unassigned locations
Â  Â  Â  Â  let lastUnassignedLocations = [];

Â  Â  Â  Â  // Store last generated schedule and assignments for override
Â  Â  Â  Â  let lastSchedule = {};
Â  Â  Â  Â  let lastAssignments = [];

Â  Â  Â  Â  // --- Data Persistence (using Local Storage now) ---
Â  Â  Â  Â  function saveAllData() {
Â  Â  Â  Â  Â  Â  localStorage.setItem('technicians', JSON.stringify(technicians));
Â  Â  Â  Â  Â  Â  localStorage.setItem('locations', JSON.stringify(locations));
Â  Â  Â  Â  Â  Â  localStorage.setItem('scopes', JSON.stringify(scopes));
Â  Â  Â  Â  Â  Â  localStorage.setItem('projectProviders', JSON.stringify(projectProviders));
Â  Â  Â  Â  }
Â  Â  Â  Â  function loadAllData() {
Â  Â  Â  Â  Â  Â  const techs = localStorage.getItem('technicians');
Â  Â  Â  Â  Â  Â  const locs = localStorage.getItem('locations');
Â  Â  Â  Â  Â  Â  const scps = localStorage.getItem('scopes');
Â  Â  Â  Â  Â  Â  const projs = localStorage.getItem('projectProviders');
Â  Â  Â  Â  Â  Â  const lastSched = localStorage.getItem('lastSchedule');
Â  Â  Â  Â  Â  Â  const lastUnassigned = localStorage.getItem('lastUnassignedLocations');

Â  Â  Â  Â  Â  Â  if (techs) {
Â  Â  Â  Â  Â  Â  Â  Â  technicians = JSON.parse(techs);
Â  Â  Â  Â  Â  Â  Â  Â  technicians.forEach(tech => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!tech.providers) tech.providers = [];
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (locs) {
Â  Â  Â  Â  Â  Â  Â  Â  locations = JSON.parse(locs);
Â  Â  Â  Â  Â  Â  Â  Â  locations.forEach(loc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!loc.days) loc.days = [];
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (scps) scopes = JSON.parse(scps);
Â  Â  Â  Â  Â  Â  if (projs) projectProviders = JSON.parse(projs);
Â  Â  Â  Â  Â  Â  if (lastSched) {
Â  Â  Â  Â  Â  Â  Â  Â  lastSchedule = JSON.parse(lastSched);
Â  Â  Â  Â  Â  Â  Â  Â  // Re-parse dates from string to Date objects
Â  Â  Â  Â  Â  Â  Â  Â  Object.values(lastSchedule).forEach(day => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (day.date) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  day.date = new Date(day.date);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  day.teams.forEach(team => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  team.assignments.forEach(assignment => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignment.startDateTime = new Date(assignment.startDateTime);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignment.endDateTime = new Date(assignment.endDateTime);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (lastUnassigned) lastUnassignedLocations = JSON.parse(lastUnassigned);
Â  Â  Â  Â  }
Â  Â  Â  Â  function saveScheduleState() {
Â  Â  Â  Â  Â  Â  localStorage.setItem('lastSchedule', JSON.stringify(lastSchedule));
Â  Â  Â  Â  Â  Â  localStorage.setItem('lastUnassignedLocations', JSON.stringify(lastUnassignedLocations));
Â  Â  Â  Â  }
Â  Â  Â  Â  function clearScheduleState() {
Â  Â  Â  Â  Â  Â  localStorage.removeItem('lastSchedule');
Â  Â  Â  Â  Â  Â  localStorage.removeItem('lastUnassignedLocations');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function getCurrentTabName() {
Â  Â  Â  Â  Â  Â  const activeTab = document.querySelector('.tab.active');
Â  Â  Â  Â  Â  Â  if (!activeTab) return 'technicians';
Â  Â  Â  Â  Â  Â  return activeTab.getAttribute('data-tab');
Â  Â  Â  Â  }
Â  Â  Â  Â  function setCurrentTab(tabName) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
Â  Â  Â  Â  Â  Â  const tabBtn = document.querySelector(`.tab[data-tab="${tabName}"]`);
Â  Â  Â  Â  Â  Â  if (tabBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  tabBtn.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  const section = document.getElementById(tabName);
Â  Â  Â  Â  Â  Â  Â  Â  if (section) section.classList.add('active');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (tabName === 'scopes') {
Â  Â  Â  Â  Â  Â  Â  Â  updateScopeList();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (tabName === 'schedule') {
Â  Â  Â  Â  Â  Â  Â  Â  updateScheduleTabContent();
Â  Â  Â  Â  Â  Â  Â  Â  displaySchedule(lastSchedule, lastUnassignedLocations);
Â  Â  Â  Â  Â  Â  Â  Â  displayMetrics(lastSchedule, lastUnassignedLocations);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Tab Logic (robust, no inline onclick, fluid UI) ---
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', function () {
Â  Â  Â  Â  Â  Â  // Tab click handler
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tab').forEach(tab => {
Â  Â  Â  Â  Â  Â  Â  Â  tab.addEventListener('click', function () {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tab.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tabName = tab.getAttribute('data-tab');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const section = document.getElementById(tabName);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (section) section.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('currentTab', tabName);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (tabName === 'scopes') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateScopeList();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (tabName === 'schedule') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateScheduleTabContent();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displaySchedule(lastSchedule, lastUnassignedLocations);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayMetrics(lastSchedule, lastUnassignedLocations);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  loadAllData();
Â  Â  Â  Â  Â  Â  const savedTab = localStorage.getItem('currentTab') || 'technicians';
Â  Â  Â  Â  Â  Â  setCurrentTab(savedTab);
Â  Â  Â  Â  });

Â  Â  Â  Â  // The initMap function is now a global callback function for the Google Maps script
Â  Â  Â  Â  function initMap() {
Â  Â  Â  Â  Â  Â  // Technician Address Autocomplete
Â  Â  Â  Â  Â  Â  const techInput = document.getElementById('techAddress');
Â  Â  Â  Â  Â  Â  if(techInput) {
Â  Â  Â  Â  Â  Â  Â  Â  const techAutocomplete = new google.maps.places.Autocomplete(techInput, { types: ['address'] });
Â  Â  Â  Â  Â  Â  Â  Â  techAutocomplete.setFields(['formatted_address']);
Â  Â  Â  Â  Â  Â  Â  Â  techAutocomplete.addListener('place_changed', function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const place = techAutocomplete.getPlace();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (place && place.formatted_address) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  techInput.value = place.formatted_address;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Location Address Autocomplete
Â  Â  Â  Â  Â  Â  const locInput = document.getElementById('locationAddress');
Â  Â  Â  Â  Â  Â  if (locInput) {
Â  Â  Â  Â  Â  Â  Â  Â  const locAutocomplete = new google.maps.places.Autocomplete(locInput, { types: ['address'] });
Â  Â  Â  Â  Â  Â  Â  Â  locAutocomplete.setFields(['formatted_address']);
Â  Â  Â  Â  Â  Â  Â  Â  locAutocomplete.addListener('place_changed', function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const place = locAutocomplete.getPlace();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (place && place.formatted_address) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  locInput.value = place.formatted_address;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function populateProviderCheckboxes() {
Â  Â  Â  Â  Â  Â  const techContainer = document.getElementById('techProviderCheckboxes');
Â  Â  Â  Â  Â  Â  const locationContainer = document.getElementById('projectProviderCheckboxes');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (techContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  techContainer.innerHTML = providers.map(p => `<label for="techProvider${p}"><input type="checkbox" id="techProvider${p}" name="techProvider" value="${p}"> ${p}</label>`).join('');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (locationContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  locationContainer.innerHTML = providers.map(p => `<label for="projectProvider${p}"><input type="checkbox" id="projectProvider${p}" name="projectProvider" value="${p}" onchange="updateProjectProviders()"> ${p}</label>`).join('');
Â  Â  Â  Â  Â  Â  Â  Â  setSelectedProviders('projectProviderCheckboxes', projectProviders);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function updateProjectProviders() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('projectProviderCheckboxes');
Â  Â  Â  Â  Â  Â  if (container) {
Â  Â  Â  Â  Â  Â  Â  Â  projectProviders = Array.from(container.querySelectorAll(`input[type="checkbox"]:checked`)).map(cb => cb.value);
Â  Â  Â  Â  Â  Â  Â  Â  saveAllData();
Â  Â  Â  Â  Â  Â  Â  Â  updateLocationList();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function getSelectedProviders(containerId) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById(containerId);
Â  Â  Â  Â  Â  Â  if (!container) return [];
Â  Â  Â  Â  Â  Â  return Array.from(container.querySelectorAll(`input[type="checkbox"]:checked`)).map(cb => cb.value);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function setSelectedProviders(containerId, selectedProviders) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll(`#${containerId} input[type="checkbox"]`).forEach(cb => {
Â  Â  Â  Â  Â  Â  Â  Â  cb.checked = (selectedProviders || []).includes(cb.value);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- New function to import technicians from CSV paste ---
Â  Â  Â  Â  function importTechnicians() {
Â  Â  Â  Â  Â  Â  const csvData = document.getElementById('csvData').value;
Â  Â  Â  Â  Â  Â  const lines = csvData.split('\n').filter(line => line.trim() !== '');
Â  Â  Â  Â  Â  Â  const newTechnicians = [];
Â  Â  Â  Â  Â  Â  let errors = [];

Â  Â  Â  Â  Â  Â  lines.forEach((line, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const parts = line.split(',');
Â  Â  Â  Â  Â  Â  Â  Â  if (parts.length < 7) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errors.push(`Row ${index + 1}: Not enough data. Expected 7 columns.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const [teamName, location, address, count, days, hours, providers] = parts.map(p => p.trim());
Â  Â  Â  Â  Â  Â  Â  Â  const [startTime, endTime] = hours.split('-').map(h => h.trim());

Â  Â  Â  Â  Â  Â  Â  Â  if (!teamName || !location || !address || !count || !days || !hours || !providers) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errors.push(`Row ${index + 1}: Missing required data.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (technicians.some(t => t.teamName === teamName) || newTechnicians.some(t => t.teamName === teamName)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errors.push(`Row ${index + 1}: Duplicate Team Name/ID.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  newTechnicians.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: Date.now() + index, // Unique ID
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  location,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  address,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count: parseInt(count),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  days: days.split(';').map(d => d.trim()),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startTime,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endTime,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  specializations: [], // Legacy field
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  providers: providers.split(';').map(p => p.trim())
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (errors.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Please fix the following errors in your data:\n" + errors.join("\n"));
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  technicians = [...technicians, ...newTechnicians];
Â  Â  Â  Â  Â  Â  updateTechnicianList();
Â  Â  Â  Â  Â  Â  saveAllData();
Â  Â  Â  Â  Â  Â  document.getElementById('csvData').value = '';
Â  Â  Â  Â  Â  Â  alert(`${newTechnicians.length} technician teams successfully imported.`);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Scope List always updates ---
Â  Â  Â  Â  function updateScopeList() {
Â  Â  Â  Â  Â  Â  const list = document.getElementById('scopeList');
Â  Â  Â  Â  Â  Â  if (!list) return;
Â  Â  Â  Â  Â  Â  if (scopes.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML = '<p style="color:#888;">No scope templates defined yet.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  list.innerHTML = scopes.map(scope => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="scope-type-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5>${scope.type}</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Duration:</strong> ${scope.duration} min/unit</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Tech Required:</strong> ${scope.techCount}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Complexity:</strong> ${scope.complexity}x</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" onclick="removeScope(${scope.id})">Remove</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Schedule Tab always shows content ---
Â  Â  Â  Â  function updateScheduleTabContent() {
Â  Â  Â  Â  Â  Â  const scheduleOutput = document.getElementById('scheduleOutput');
Â  Â  Â  Â  Â  Â  if (!scheduleOutput) return;
Â  Â  Â  Â  Â  Â  if (scopes.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  scheduleOutput.innerHTML = '<div class="error">Please define at least one scope template before generating a schedule.</div>';
Â  Â  Â  Â  Â  Â  } else if (technicians.length === 0 || locations.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  scheduleOutput.innerHTML = '<div class="error">Please add at least one technician team and one location before generating a schedule.</div>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  scheduleOutput.innerHTML = '<h3>Generated Schedule will appear here...</h3>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  displayMetrics({}, []);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Initialization ---
Â  Â  Â  Â  window.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  Â  Â  Â  loadAllData();
Â  Â  Â  Â  Â  Â  updateTechnicianList();
Â  Â  Â  Â  Â  Â  updateLocationList();
Â  Â  Â  Â  Â  Â  updateScopeList();
Â  Â  Â  Â  Â  Â  // Restore tab
Â  Â  Â  Â  Â  Â  const savedTab = localStorage.getItem('currentTab') || 'technicians';
Â  Â  Â  Â  Â  Â  setCurrentTab(savedTab);
Â  Â  Â  Â  Â  Â  // Ensure scope and schedule sections are populated
Â  Â  Â  Â  Â  Â  updateScopeList();
Â  Â  Â  Â  Â  Â  updateScheduleTabContent();
Â  Â  Â  Â  Â  Â  populateProviderCheckboxes();
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- Helper function to format 24h time to 12h AM/PM ---
Â  Â  Â  Â  function formatTime(timeString) {
Â  Â  Â  Â  Â  Â  if (!timeString) return '';
Â  Â  Â  Â  Â  Â  const [hour, minute] = timeString.split(':');
Â  Â  Â  Â  Â  Â  const h = parseInt(hour, 10);
Â  Â  Â  Â  Â  Â  const m = parseInt(minute, 10);
Â  Â  Â  Â  Â  Â  const ampm = h >= 12 ? 'PM' : 'AM';
Â  Â  Â  Â  Â  Â  const formattedHour = h % 12 === 0 ? 12 : h % 12;
Â  Â  Â  Â  Â  Â  return `${formattedHour}:${m.toString().padStart(2, '0')} ${ampm}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Technician CRUD ---
Â  Â  Â  Â  function getSelectedTechDays() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('techDaysCheckboxes');
Â  Â  Â  Â  Â  Â  if (!container) return [];
Â  Â  Â  Â  Â  Â  return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
Â  Â  Â  Â  }
Â  Â  Â  Â  function setSelectedTechDays(days) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#techDaysCheckboxes input[type="checkbox"]').forEach(cb => {
Â  Â  Â  Â  Â  Â  Â  Â  cb.checked = (days || []).includes(cb.value);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  function addTechnician() {
Â  Â  Â  Â  Â  Â  const location = document.getElementById('techLocation')?.value.trim();
Â  Â  Â  Â  Â  Â  const address = document.getElementById('techAddress')?.value.trim();
Â  Â  Â  Â  Â  Â  const count = parseInt(document.getElementById('techCount')?.value);
Â  Â  Â  Â  Â  Â  const teamName = document.getElementById('techTeamName')?.value.trim();
Â  Â  Â  Â  Â  Â  const days = getSelectedTechDays();
Â  Â  Â  Â  Â  Â  const startTime = document.getElementById('techStartTime')?.value;
Â  Â  Â  Â  Â  Â  const endTime = document.getElementById('techEndTime')?.value;
Â  Â  Â  Â  Â  Â  const specializations = document.getElementById('techSpecializations')?.value.split(',').map(s => s.trim()).filter(Boolean) || [];
Â  Â  Â  Â  Â  Â  const providers = getSelectedProviders('techProviderCheckboxes');

Â  Â  Â  Â  Â  Â  let errors = [];
Â  Â  Â  Â  Â  Â  if (!location) errors.push("Base Location is required.");
Â  Â  Â  Â  Â  Â  if (!address) errors.push("Technician Address is required.");
Â  Â  Â  Â  Â  Â  if (!count || count < 1) errors.push("Number of Technicians must be at least 1.");
Â  Â  Â  Â  Â  Â  if (!teamName) errors.push("Team Name/ID is required.");
Â  Â  Â  Â  Â  Â  if (days.length === 0) errors.push("At least one availability day must be selected.");
Â  Â  Â  Â  Â  Â  if (!startTime || !endTime) errors.push("Working hours are required.");
Â  Â  Â  Â  Â  Â  if (technicians.some(t => t.teamName === teamName && t.id !== editTechId)) errors.push("Team Name/ID must be unique.");
Â  Â  Â  Â  Â  Â  if (providers.length === 0) errors.push("At least one provider must be selected.");

Â  Â  Â  Â  Â  Â  if (errors.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Please fix the following:\n" + errors.join("\n"));
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (editTechId !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  const idx = technicians.findIndex(t => t.id === editTechId);
Â  Â  Â  Â  Â  Â  Â  Â  if (idx !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  technicians[idx] = { id: editTechId, location, address, count, teamName, days, startTime, endTime, specializations, providers };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  editTechId = null;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('addTechBtn').textContent = "Add Technician Team";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const tech = { id: Date.now(), location, address, count, teamName, days, startTime, endTime, specializations, providers };
Â  Â  Â  Â  Â  Â  Â  Â  technicians.push(tech);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateTechnicianList();
Â  Â  Â  Â  Â  Â  clearTechForm();
Â  Â  Â  Â  Â  Â  saveAllData();
Â  Â  Â  Â  }
Â  Â  Â  Â  function clearTechForm() {
Â  Â  Â  Â  Â  Â  if (document.getElementById('techLocation')) document.getElementById('techLocation').value = '';
Â  Â  Â  Â  Â  Â  if (document.getElementById('techAddress')) document.getElementById('techAddress').value = '';
Â  Â  Â  Â  Â  Â  if (document.getElementById('techCount')) document.getElementById('techCount').value = '1';
Â  Â  Â  Â  Â  Â  if (document.getElementById('techTeamName')) document.getElementById('techTeamName').value = '';
Â  Â  Â  Â  Â  Â  if (document.getElementById('techSpecializations')) document.getElementById('techSpecializations').value = '';
Â  Â  Â  Â  Â  Â  setSelectedTechDays(['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday']);
Â  Â  Â  Â  Â  Â  setSelectedProviders('techProviderCheckboxes', []);
Â  Â  Â  Â  Â  Â  if (document.getElementById('techStartTime')) document.getElementById('techStartTime').value = '08:00';
Â  Â  Â  Â  Â  Â  if (document.getElementById('techEndTime')) document.getElementById('techEndTime').value = '17:00';
Â  Â  Â  Â  Â  Â  editTechId = null;
Â  Â  Â  Â  Â  Â  if (document.getElementById('addTechBtn')) document.getElementById('addTechBtn').textContent = "Add Technician Team";
Â  Â  Â  Â  }
Â  Â  Â  Â  function updateTechnicianList() {
Â  Â  Â  Â  Â  Â  const list = document.getElementById('technicianList');
Â  Â  Â  Â  Â  Â  if (technicians.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML = '<p style="color:#888;">No technician teams added yet.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  list.innerHTML = technicians.map(tech => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${tech.teamName}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-secondary" onclick="editTechnician(${tech.id})">Edit</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" onclick="removeTechnician(${tech.id})">Remove</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Location:</strong> ${tech.location}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Address:</strong> ${tech.address || '-'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Team Size:</strong> ${tech.count} technicians</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Available:</strong> ${tech.days.join(', ')}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Hours:</strong> ${formatTime(tech.startTime)} - ${formatTime(tech.endTime)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Certifications:</strong> ${(tech.providers || []).join(', ') || 'None'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â  function editTechnician(id) {
Â  Â  Â  Â  Â  Â  const tech = technicians.find(t => t.id === id);
Â  Â  Â  Â  Â  Â  if (!tech) return;
Â  Â  Â  Â  Â  Â  if (document.getElementById('techLocation')) document.getElementById('techLocation').value = tech.location;
Â  Â  Â  Â  Â  Â  if (document.getElementById('techAddress')) document.getElementById('techAddress').value = tech.address;
Â  Â  Â  Â  Â  Â  if (document.getElementById('techCount')) document.getElementById('techCount').value = tech.count;
Â  Â  Â  Â  Â  Â  if (document.getElementById('techTeamName')) document.getElementById('techTeamName').value = tech.teamName;
Â  Â  Â  Â  Â  Â  if (document.getElementById('techSpecializations')) document.getElementById('techSpecializations').value = tech.specializations?.join(', ') || '';
Â  Â  Â  Â  Â  Â  setSelectedTechDays(tech.days);
Â  Â  Â  Â  Â  Â  setSelectedProviders('techProviderCheckboxes', tech.providers || []);
Â  Â  Â  Â  Â  Â  if (document.getElementById('techStartTime')) document.getElementById('techStartTime').value = tech.startTime;
Â  Â  Â  Â  Â  Â  if (document.getElementById('techEndTime')) document.getElementById('techEndTime').value = tech.endTime;
Â  Â  Â  Â  Â  Â  editTechId = id;
Â  Â  Â  Â  Â  Â  if (document.getElementById('addTechBtn')) document.getElementById('addTechBtn').textContent = "Save Technician Team";
Â  Â  Â  Â  Â  Â  if (document.getElementById('techLocation')) document.getElementById('techLocation').focus();
Â  Â  Â  Â  }
Â  Â  Â  Â  function removeTechnician(id) {
Â  Â  Â  Â  Â  Â  technicians = technicians.filter(t => t.id !== id);
Â  Â  Â  Â  Â  Â  updateTechnicianList();
Â  Â  Â  Â  Â  Â  saveAllData();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Location CRUD ---
Â  Â  Â  Â  function getSelectedLocationDays() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('locationDayCheckboxes');
Â  Â  Â  Â  Â  Â  if (!container) return [];
Â  Â  Â  Â  Â  Â  return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
Â  Â  Â  Â  }

Â  Â  Â  Â  function setSelectedLocationDays(days) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#locationDayCheckboxes input[type="checkbox"]').forEach(cb => {
Â  Â  Â  Â  Â  Â  Â  Â  cb.checked = (days || []).includes(cb.value);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function addLocation() {
Â  Â  Â  Â  Â  Â  const siteId = document.getElementById('locationId')?.value.trim();
Â  Â  Â  Â  Â  Â  const name = document.getElementById('locationName')?.value.trim();
Â  Â  Â  Â  Â  Â  const address = document.getElementById('locationAddress')?.value.trim();
Â  Â  Â  Â  Â  Â  const scope = document.getElementById('locationScope')?.value.trim();
Â  Â  Â  Â  Â  Â  const priority = document.getElementById('locationPriority')?.value;
Â  Â  Â  Â  Â  Â  const days = getSelectedLocationDays();
Â  Â  Â  Â  Â  Â  const startTime = document.getElementById('locationStartTime')?.value;
Â  Â  Â  Â  Â  Â  const endTime = document.getElementById('locationEndTime')?.value;
Â  Â  Â  Â  Â  Â  const contact = document.getElementById('locationContact')?.value.trim();
Â  Â  Â  Â  Â  Â  const notes = document.getElementById('locationNotes')?.value.trim();

Â  Â  Â  Â  Â  Â  let errors = [];
Â  Â  Â  Â  Â  Â  if (!siteId) errors.push("Site ID is required.");
Â  Â  Â  Â  Â  Â  if (!address) errors.push("Full Address is required.");
Â  Â  Â  Â  Â  Â  if (!scope) errors.push("Scope of Work is required.");
Â  Â  Â  Â  Â  Â  if (locations.some(l => l.siteId === siteId && l.id !== editLocationId)) errors.push("Site ID must be unique.");
Â  Â  Â  Â  Â  Â  if (projectProviders.length === 0) errors.push("At least one provider must be selected for the project.");
Â  Â  Â  Â  Â  Â  if (days.length === 0) errors.push("At least one availability day must be selected.");
Â  Â  Â  Â  Â  Â  if (!startTime || !endTime) errors.push("Site hours are required.");

Â  Â  Â  Â  Â  Â  const scopeItems = parseScope(scope);
Â  Â  Â  Â  Â  Â  const missingScopes = scopeItems.filter(item =>
Â  Â  Â  Â  Â  Â  Â  Â  !scopes.some(s =>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.type.toLowerCase().includes(s.type.toLowerCase()) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  s.type.toLowerCase().includes(item.type.toLowerCase())
Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  if (missingScopes.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Please fix the following:\n" + "Scope type(s) not defined: " + missingScopes.map(s => s.type).join(', '));
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (errors.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Please fix the following:\n" + errors.join("\n"));
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (editLocationId !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  const idx = locations.findIndex(l => l.id === editLocationId);
Â  Â  Â  Â  Â  Â  Â  Â  if (idx !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  locations[idx] = { id: editLocationId, siteId, name, address, scope, priority, days, startTime, endTime, contact, notes, providers: projectProviders };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  editLocationId = null;
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector('button[onclick="addLocation()"]').textContent = "Add Location";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const location = { id: Date.now(), siteId, name, address, scope, priority, days, startTime, endTime, contact, notes, providers: projectProviders };
Â  Â  Â  Â  Â  Â  Â  Â  locations.push(location);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateLocationList();
Â  Â  Â  Â  Â  Â  clearLocationForm();
Â  Â  Â  Â  Â  Â  saveAllData();
Â  Â  Â  Â  }
Â  Â  Â  Â  function updateLocationList() {
Â  Â  Â  Â  Â  Â  const list = document.getElementById('locationList');
Â  Â  Â  Â  Â  Â  if (locations.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML = '<p style="color:#888;">No locations added yet.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  list.innerHTML = locations.map(loc => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${loc.siteId} - ${loc.name || 'Unnamed'}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-secondary" onclick="editLocation(${loc.id})">Edit</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" onclick="removeLocation(${loc.id})">Remove</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Address:</strong> ${loc.address}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Scope:</strong> ${loc.scope}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Priority:</strong> <span class="tech-tag">${loc.priority}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Availability:</strong> ${(loc.days || []).join(', ')} (${formatTime(loc.startTime)} - ${formatTime(loc.endTime)})</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Providers:</strong> ${(projectProviders || []).join(', ') || 'None'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${loc.contact ? `<p><strong>Contact:</strong> ${loc.contact}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${loc.notes ? `<p><strong>Notes:</strong> ${loc.notes}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â  function editLocation(id) {
Â  Â  Â  Â  Â  Â  const loc = locations.find(l => l.id === id);
Â  Â  Â  Â  Â  Â  if (!loc) return;
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationId')) document.getElementById('locationId').value = loc.siteId;
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationName')) document.getElementById('locationName').value = loc.name;
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationAddress')) document.getElementById('locationAddress').value = loc.address;
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationScope')) document.getElementById('locationScope').value = loc.scope;
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationPriority')) document.getElementById('locationPriority').value = loc.priority;
Â  Â  Â  Â  Â  Â  setSelectedLocationDays(loc.days || []);
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationStartTime')) document.getElementById('locationStartTime').value = loc.startTime;
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationEndTime')) document.getElementById('locationEndTime').value = loc.endTime;
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationContact')) document.getElementById('locationContact').value = loc.contact;
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationNotes')) document.getElementById('locationNotes').value = loc.notes;
Â  Â  Â  Â  Â  Â  editLocationId = id;
Â  Â  Â  Â  Â  Â  if (document.querySelector('button[onclick="addLocation()"]')) document.querySelector('button[onclick="addLocation()"]').textContent = "Save Location";
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationId')) document.getElementById('locationId').focus();
Â  Â  Â  Â  }
Â  Â  Â  Â  function removeLocation(id) {
Â  Â  Â  Â  Â  Â  locations = locations.filter(l => l.id !== id);
Â  Â  Â  Â  Â  Â  updateLocationList();
Â  Â  Â  Â  Â  Â  clearLocationForm();
Â  Â  Â  Â  Â  Â  saveAllData();
Â  Â  Â  Â  }
Â  Â  Â  Â  function clearLocationForm() {
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationId')) document.getElementById('locationId').value = '';
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationName')) document.getElementById('locationName').value = '';
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationAddress')) document.getElementById('locationAddress').value = '';
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationScope')) document.getElementById('locationScope').value = '';
Â  Â  Â  Â  Â  Â  setSelectedLocationDays(['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday']);
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationStartTime')) document.getElementById('locationStartTime').value = '09:00';
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationEndTime')) document.getElementById('locationEndTime').value = '17:00';
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationContact')) document.getElementById('locationContact').value = '';
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationNotes')) document.getElementById('locationNotes').value = '';
Â  Â  Â  Â  Â  Â  if (document.getElementById('locationPriority')) document.getElementById('locationPriority').value = 'Medium';
Â  Â  Â  Â  Â  Â  editLocationId = null;
Â  Â  Â  Â  Â  Â  if (document.querySelector('button[onclick="addLocation()"]')) document.querySelector('button[onclick="addLocation()"]').textContent = "Add Location";
Â  Â  Â  Â  Â  Â  currentLocationScopes = [];
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Scope CRUD ---
Â  Â  Â  Â  function addScope() {
Â  Â  Â  Â  Â  Â  const type = document.getElementById('scopeType')?.value.trim();
Â  Â  Â  Â  Â  Â  const duration = parseInt(document.getElementById('scopeDuration')?.value);
Â  Â  Â  Â  Â  Â  const techCount = parseInt(document.getElementById('scopeTechCount')?.value);
Â  Â  Â  Â  Â  Â  const complexity = parseFloat(document.getElementById('scopeComplexity')?.value);

Â  Â  Â  Â  Â  Â  let errors = [];
Â  Â  Â  Â  Â  Â  if (!type) errors.push("Scope Type is required.");
Â  Â  Â  Â  Â  Â  if (!duration || duration < 1) errors.push("Duration per Unit must be at least 1.");
Â  Â  Â  Â  Â  Â  if (!techCount || techCount < 1) errors.push("Required Tech Count must be at least 1.");
Â  Â  Â  Â  Â  Â  if (!complexity || complexity < 1) errors.push("Complexity Factor must be at least 1.");
Â  Â  Â  Â  Â  Â  if (scopes.some(s => s.type.toLowerCase() === type.toLowerCase())) errors.push("Scope Type must be unique.");

Â  Â  Â  Â  Â  Â  if (errors.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Please fix the following:\n" + errors.join("\n"));
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const scope = { id: Date.now(), type, duration, techCount, complexity };

Â  Â  Â  Â  Â  Â  scopes.push(scope);
Â  Â  Â  Â  Â  Â  updateScopeList();
Â  Â  Â  Â  Â  Â  clearScopeForm();
Â  Â  Â  Â  Â  Â  saveAllData();
Â  Â  Â  Â  }
Â  Â  Â  Â  function clearScopeForm() {
Â  Â  Â  Â  Â  Â  if (document.getElementById('scopeType')) document.getElementById('scopeType').value = '';
Â  Â  Â  Â  Â  Â  if (document.getElementById('scopeDuration')) document.getElementById('scopeDuration').value = '';
Â  Â  Â  Â  Â  Â  if (document.getElementById('scopeTechCount')) document.getElementById('scopeTechCount').value = '1';
Â  Â  Â  Â  Â  Â  if (document.getElementById('scopeComplexity')) document.getElementById('scopeComplexity').value = '1';
Â  Â  Â  Â  }
Â  Â  Â  Â  function updateScopeList() {
Â  Â  Â  Â  Â  Â  const list = document.getElementById('scopeList');
Â  Â  Â  Â  Â  Â  if (!list) return;
Â  Â  Â  Â  Â  Â  if (scopes.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML = '<p style="color:#888;">No scope templates defined yet.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  list.innerHTML = scopes.map(scope => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="scope-type-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5>${scope.type}</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Duration:</strong> ${scope.duration} min/unit</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Tech Required:</strong> ${scope.techCount}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Complexity:</strong> ${scope.complexity}x</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" onclick="removeScope(${scope.id})">Remove</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â  function removeScope(id) {
Â  Â  Â  Â  Â  Â  scopes = scopes.filter(s => s.id !== id);
Â  Â  Â  Â  Â  Â  updateScopeList();
Â  Â  Â  Â  Â  Â  saveAllData();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Helper: Parse scope string into items ---
Â  Â  Â  Â  function parseScope(scopeString) {
Â  Â  Â  Â  Â  Â  const items = [];
Â  Â  Â  Â  Â  Â  const parts = scopeString.split(',');
Â  Â  Â  Â  Â  Â  parts.forEach(part => {
Â  Â  Â  Â  Â  Â  Â  Â  const match = part.trim().match(/(\d+)\s*(.+)/);
Â  Â  Â  Â  Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const [_, quantity, type] = match;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  items.push({ quantity: parseInt(quantity), type: type.trim() });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  return items;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Helper: Calculate job duration based on scope ---
Â  Â  Â  Â  function calculateJobDuration(scopeString) {
Â  Â  Â  Â  Â  Â  const scopeItems = parseScope(scopeString);
Â  Â  Â  Â  Â  Â  let totalDuration = 0;
Â  Â  Â  Â  Â  Â  scopeItems.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  const scopeTemplate = scopes.find(s =>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.type.toLowerCase().includes(s.type.toLowerCase()) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  s.type.toLowerCase().includes(item.type.toLowerCase())
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  if (scopeTemplate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalDuration += item.quantity * scopeTemplate.duration * scopeTemplate.complexity;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalDuration += item.quantity * 30; // fallback
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  return totalDuration;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Helper: Calculate driving time and distance using Google Maps Distance Matrix API ---
Â  Â  Â  Â  async function getDriveInfo(origin, destination) {
Â  Â  Â  Â  Â  Â  return new Promise((resolve) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!origin || !destination) return resolve({minutes: 0, miles: 0});
Â  Â  Â  Â  Â  Â  Â  Â  if (!window.google || !window.google.maps || !window.google.maps.DistanceMatrixService) return resolve({minutes: 30, miles: 10});
Â  Â  Â  Â  Â  Â  Â  Â  const service = new google.maps.DistanceMatrixService();
Â  Â  Â  Â  Â  Â  Â  Â  service.getDistanceMatrix(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  origins: [origin],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  destinations: [destination],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  travelMode: google.maps.TravelMode.DRIVING,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unitSystem: google.maps.UnitSystem.IMPERIAL,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (response, status) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (status === "OK" && response.rows[0].elements[0].status === "OK") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const duration = response.rows[0].elements[0].duration.value; // seconds
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const distance = response.rows[0].elements[0].distance.value; // meters
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const miles = (distance / 1609.34).toFixed(1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve({minutes: Math.round(duration / 60), miles: miles});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve({minutes: 30, miles: 10});
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Helper: Get available days for a location ---
Â  Â  Â  Â  function getLocationAvailableDays(location) {
Â  Â  Â  Â  Â  Â  return location.days || [];
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Helper: Get location available time window ---
Â  Â  Â  Â  function getLocationAvailableTime(location) {
Â  Â  Â  Â  Â  Â  let startHour = 9, startMin = 0, endHour = 17, endMin = 0;
Â  Â  Â  Â  Â  Â  if (location.startTime) {
Â  Â  Â  Â  Â  Â  Â  Â  const [h, m] = location.startTime.split(':');
Â  Â  Â  Â  Â  Â  Â  Â  startHour = parseInt(h);
Â  Â  Â  Â  Â  Â  Â  Â  startMin = parseInt(m);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (location.endTime) {
Â  Â  Â  Â  Â  Â  Â  Â  const [h, m] = location.endTime.split(':');
Â  Â  Â  Â  Â  Â  Â  Â  endHour = parseInt(h);
Â  Â  Â  Â  Â  Â  Â  Â  endMin = parseInt(m);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return { startHour, startMin, endHour, endMin };
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Helper function to format duration in hours and minutes ---
Â  Â  Â  Â  function formatDuration(minutes) {
Â  Â  Â  Â  Â  Â  if (minutes < 60) {
Â  Â  Â  Â  Â  Â  Â  Â  return `${minutes} minutes`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const hours = Math.floor(minutes / 60);
Â  Â  Â  Â  Â  Â  const mins = minutes % 60;
Â  Â  Â  Â  Â  Â  return `${hours} hour${hours > 1 ? 's' : ''}${mins > 0 ? `, ${mins} minute${mins > 1 ? 's' : ''}` : ''}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Advanced Scheduling Logic ---
Â  Â  Â  Â  async function generateSchedule() {
Â  Â  Â  Â  Â  Â  if (technicians.length === 0 || locations.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Please add at least one technician team and one location');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (scopes.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Please define at least one scope template.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (projectProviders.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Please select at least one provider for the project.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('scheduleOutput').innerHTML = '<h3>Generating schedule, please wait...</h3>';

Â  Â  Â  Â  Â  Â  const strategy = document.getElementById('optimizationStrategy')?.value;
Â  Â  Â  Â  Â  Â  let sortedLocations = [...locations];
Â  Â  Â  Â  Â  Â  if (strategy === 'priority') {
Â  Â  Â  Â  Â  Â  Â  Â  const priorityOrder = { 'High': 1, 'Medium': 2, 'Low': 3 };
Â  Â  Â  Â  Â  Â  Â  Â  sortedLocations.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const schedule = {};
Â  Â  Â  Â  Â  Â  const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const installWindowStart = document.getElementById('installWindowStart')?.value;
Â  Â  Â  Â  Â  Â  const installWindowEnd = document.getElementById('installWindowEnd')?.value;
Â  Â  Â  Â  Â  Â  const windowStart = installWindowStart ? new Date(installWindowStart + "T00:00:00") : null;
Â  Â  Â  Â  Â  Â  const windowEnd = installWindowEnd ? new Date(installWindowEnd + "T23:59:59") : null;

Â  Â  Â  Â  Â  Â  const driveInfoCache = {};
Â  Â  Â  Â  Â  Â  async function getDriveInfoCached(origin, destination) {
Â  Â  Â  Â  Â  Â  Â  Â  const key = `${origin}|${destination}`;
Â  Â  Â  Â  Â  Â  Â  Â  if (driveInfoCache[key] !== undefined) return driveInfoCache[key];
Â  Â  Â  Â  Â  Â  Â  Â  const info = await getDriveInfo(origin, destination);
Â  Â  Â  Â  Â  Â  Â  Â  driveInfoCache[key] = info;
Â  Â  Â  Â  Â  Â  Â  Â  return info;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const techUsage = {};
Â  Â  Â  Â  Â  Â  technicians.forEach(tech => {
Â  Â  Â  Â  Â  Â  Â  Â  techUsage[tech.id] = {};
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let currentDate = new Date(installWindowStart + "T00:00:00");
Â  Â  Â  Â  Â  Â  if (!installWindowStart) {
Â  Â  Â  Â  Â  Â  Â  Â  currentDate = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  currentDate.setHours(0,0,0,0);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let locationsToRetry = sortedLocations.map(loc => ({ ...loc, remainingDuration: calculateJobDuration(loc.scope), originalScope: loc.scope }));
Â  Â  Â  Â  Â  Â  let unassignedLocations = [];

Â  Â  Â  Â  Â  Â  const maxDays = 365;
Â  Â  Â  Â  Â  Â  let loopGuard = 0;

Â  Â  Â  Â  Â  Â  while (locationsToRetry.length > 0 && loopGuard < maxDays) {
Â  Â  Â  Â  Â  Â  Â  Â  loopGuard++;
Â  Â  Â  Â  Â  Â  Â  Â  const dayOfWeek = days[currentDate.getDay()];
Â  Â  Â  Â  Â  Â  Â  Â  let didScheduleThisDay = false;

Â  Â  Â  Â  Â  Â  Â  Â  const currentDayQueue = [...locationsToRetry];
Â  Â  Â  Â  Â  Â  Â  Â  locationsToRetry.length = 0; // Clear the retry queue for a fresh start

Â  Â  Â  Â  Â  Â  Â  Â  for (const location of currentDayQueue) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { startHour: locStartHour, startMin: locStartMin, endHour: locEndHour, endMin: locEndMin } = getLocationAvailableTime(location);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isLocationAvailable = getLocationAvailableDays(location).includes(dayOfWeek);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let scheduledThisLocation = false;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isLocationAvailable && (!windowEnd || currentDate <= windowEnd)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const eligibleTeams = technicians.filter(tech => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const hasProviderMatch = (projectProviders || []).every(provider => (tech.providers || []).includes(provider));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return (tech.days || []).includes(dayOfWeek) && (tech.count - (techUsage[tech.id][currentDate.toISOString().split('T')[0]] || 0)) > 0 && hasProviderMatch;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (eligibleTeams.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const scopeItems = parseScope(location.originalScope);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let requiredTechs = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scopeItems.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const scopeTemplate = scopes.find(s => s.type.toLowerCase().includes(item.type.toLowerCase()));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (scopeTemplate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requiredTechs = Math.max(requiredTechs, scopeTemplate.techCount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eligibleTeams.sort((a, b) => (b.count - (techUsage[b.id][currentDate.toISOString().split('T')[0]] || 0)) - (a.count - (techUsage[a.id][currentDate.toISOString().split('T')[0]] || 0)));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let assignedTeams = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let assignedTechCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let primaryTeamDriveInfo = null;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(const team of eligibleTeams) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const availableTechsInTeam = team.count - (techUsage[team.id][currentDate.toISOString().split('T')[0]] || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(availableTechsInTeam <= 0) continue;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const techsToAssign = Math.min(availableTechsInTeam, requiredTechs - assignedTechCount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (techsToAssign > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!primaryTeamDriveInfo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  primaryTeamDriveInfo = await getDriveInfoCached(team.address, location.address);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignedTeams.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamId: team.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamName: team.teamName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignedTechs: techsToAssign,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  driveInfo: await getDriveInfoCached(team.address, location.address)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignedTechCount += techsToAssign;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (assignedTechCount >= requiredTechs) break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (assignedTechCount >= requiredTechs && primaryTeamDriveInfo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const teamStart = eligibleTeams[0].startTime.split(':');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const teamEnd = eligibleTeams[0].endTime.split(':');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayStartTime = new Date(currentDate);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dayStartTime.setHours(Math.max(parseInt(teamStart[0]), locStartHour), Math.max(parseInt(teamStart[1]), locStartMin), 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayEndTime = new Date(currentDate);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dayEndTime.setHours(Math.min(parseInt(teamEnd[0]), locEndHour), Math.min(parseInt(teamEnd[1]), locEndMin), 0, 0);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const availableWorkMinutes = (dayEndTime.getTime() - dayStartTime.getTime()) / 60000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const workToday = Math.min(location.remainingDuration, availableWorkMinutes);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const jobStartTime = new Date(dayStartTime);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const jobEndTime = new Date(jobStartTime.getTime() + workToday * 60000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newAssignment = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  location: location,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startDateTime: jobStartTime,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endDateTime: jobEndTime,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration: workToday,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  driveTime: primaryTeamDriveInfo.minutes,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  driveMiles: primaryTeamDriveInfo.miles,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignedTeams: assignedTeams,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  day: dayOfWeek,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  overrideParams: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requiredTechs: requiredTechs,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: Date.now()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!schedule[currentDate.toISOString()]) schedule[currentDate.toISOString()] = { date: currentDate, teams: [] };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(const assignedTeam of assignedTeams) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let teamEntry = schedule[currentDate.toISOString()].teams.find(t => t.team.id === assignedTeam.teamId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!teamEntry) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalTeam = technicians.find(t => t.id === assignedTeam.teamId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamEntry = { team: originalTeam, assignments: [] };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  schedule[currentDate.toISOString()].teams.push(teamEntry);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamEntry.assignments.push(newAssignment);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  techUsage[assignedTeam.teamId][currentDate.toISOString().split('T')[0]] = (techUsage[assignedTeam.teamId][currentDate.toISOString().split('T')[0]] || 0) + assignedTeam.assignedTechs;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  location.remainingDuration -= workToday;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  location.scope = `${location.remainingDuration} min remaining`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (location.remainingDuration <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scheduledThisLocation = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  didScheduleThisDay = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  location.scope = location.originalScope;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete location.originalScope;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  locationsToRetry.push(location);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scheduledThisLocation = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  didScheduleThisDay = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!scheduledThisLocation) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  locationsToRetry.push(location);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!didScheduleThisDay && locationsToRetry.length === currentDayQueue.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unassignedLocations = [...locationsToRetry];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  locationsToRetry = [];
Â  Â  Â  Â  Â  Â  Â  Â  } else if (didScheduleThisDay) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentDate.setDate(currentDate.getDate() + 1);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  lastUnassignedLocations = unassignedLocations;
Â  Â  Â  Â  Â  Â  lastSchedule = schedule;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Clean up temporary properties before saving
Â  Â  Â  Â  Â  Â  locations.forEach(loc => {
Â  Â  Â  Â  Â  Â  Â  Â  delete loc.remainingDuration;
Â  Â  Â  Â  Â  Â  Â  Â  delete loc.originalScope;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Restore original scope for all locations for display
Â  Â  Â  Â  Â  Â  unassignedLocations = unassignedLocations.map(loc => {
Â  Â  Â  Â  Â  Â  Â  Â  if (loc.originalScope) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loc.scope = loc.originalScope;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete loc.originalScope;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return loc;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  lastUnassignedLocations = unassignedLocations;
Â  Â  Â  Â  Â  Â  lastSchedule = schedule;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  saveAllData();
Â  Â  Â  Â  Â  Â  saveScheduleState();
Â  Â  Â  Â  Â  Â  displaySchedule(schedule, unassignedLocations, false);
Â  Â  Â  Â  Â  Â  displayMetrics(schedule, unassignedLocations);
Â  Â  Â  Â  }

Â  Â  Â  Â  async function overrideUnassignedSchedule() {
Â  Â  Â  Â  Â  Â  if (!lastUnassignedLocations || lastUnassignedLocations.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('No unassigned locations to override.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('scheduleOutput').innerHTML = '<h3>Overriding parameters for unassigned locations...</h3>';

Â  Â  Â  Â  Â  Â  const installWindowStart = document.getElementById('installWindowStart')?.value;
Â  Â  Â  Â  Â  Â  const installWindowEnd = document.getElementById('installWindowEnd')?.value;
Â  Â  Â  Â  Â  Â  let windowStart = installWindowStart ? new Date(installWindowStart + "T00:00:00") : null;
Â  Â  Â  Â  Â  Â  let windowEnd = installWindowEnd ? new Date(installWindowEnd + "T23:59:59") : null;

Â  Â  Â  Â  Â  Â  const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
Â  Â  Â  Â  Â  Â  const driveInfoCache = {};
Â  Â  Â  Â  Â  Â  async function getDriveInfoCached(origin, destination) {
Â  Â  Â  Â  Â  Â  Â  Â  const key = `${origin}|${destination}`;
Â  Â  Â  Â  Â  Â  Â  Â  if (driveInfoCache[key] !== undefined) return driveInfoCache[key];
Â  Â  Â  Â  Â  Â  Â  Â  const info = await getDriveInfo(origin, destination);
Â  Â  Â  Â  Â  Â  Â  Â  driveInfoCache[key] = info;
Â  Â  Â  Â  Â  Â  Â  Â  return info;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const techUsage = {};
Â  Â  Â  Â  Â  Â  technicians.forEach(tech => {
Â  Â  Â  Â  Â  Â  Â  Â  techUsage[tech.id] = {};
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  let unassignedCopy = lastUnassignedLocations.map(loc => ({ ...loc, remainingDuration: calculateJobDuration(loc.scope), originalScope: loc.scope }));
Â  Â  Â  Â  Â  Â  lastUnassignedLocations = [];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let currentDate = new Date();
Â  Â  Â  Â  Â  Â  currentDate.setHours(0,0,0,0);
Â  Â  Â  Â  Â  Â  let loopGuard = 0;

Â  Â  Â  Â  Â  Â  let schedule = JSON.parse(JSON.stringify(lastSchedule)); // Deep copy

Â  Â  Â  Â  Â  Â  while (unassignedCopy.length > 0 && loopGuard < 1000) {
Â  Â  Â  Â  Â  Â  Â  Â  loopGuard++;
Â  Â  Â  Â  Â  Â  Â  Â  const dayOfWeek = days[currentDate.getDay()];
Â  Â  Â  Â  Â  Â  Â  Â  const locationsToProcessThisDay = [...unassignedCopy];
Â  Â  Â  Â  Â  Â  Â  Â  let didScheduleThisDay = false;

Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < locationsToProcessThisDay.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const location = locationsToProcessThisDay[i];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let jobDurationMinutes = location.remainingDuration;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let scheduledThisLocation = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isLocationAvailable = getLocationAvailableDays(location).includes(dayOfWeek);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isLocationAvailable && (!windowStart || currentDate >= windowStart) && (!windowEnd || currentDate <= windowEnd)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const eligibleTeams = technicians.filter(team => (team.count - (techUsage[team.id][currentDate.toISOString().split('T')[0]] || 0)) > 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (eligibleTeams.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const scopeItems = parseScope(location.originalScope || location.scope);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let requiredTechs = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scopeItems.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const scopeTemplate = scopes.find(s => s.type.toLowerCase().includes(item.type.toLowerCase()));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (scopeTemplate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requiredTechs = Math.max(requiredTechs, scopeTemplate.techCount);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eligibleTeams.sort((a, b) => (b.count - (techUsage[b.id][currentDate.toISOString().split('T')[0]] || 0)) - (a.count - (techUsage[a.id][currentDate.toISOString().split('T')[0]] || 0)));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let assignedTeams = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let assignedTechCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let primaryTeamDriveInfo = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let paramsBroken = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(const team of eligibleTeams) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const availableTechsInTeam = team.count - (techUsage[team.id][currentDate.toISOString().split('T')[0]] || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(availableTechsInTeam <= 0) continue;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const techsToAssign = Math.min(availableTechsInTeam, requiredTechs - assignedTechCount);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(techsToAssign > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const hasProviderMatch = (projectProviders || []).every(provider => (team.providers || []).includes(provider));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!hasProviderMatch) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  paramsBroken.push("Provider Certification");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!(team.days || []).includes(dayOfWeek)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  paramsBroken.push("Team Availability");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!primaryTeamDriveInfo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  primaryTeamDriveInfo = await getDriveInfoCached(team.address, location.address);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignedTeams.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamId: team.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamName: team.teamName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignedTechs: techsToAssign,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  driveInfo: await getDriveInfoCached(team.address, location.address)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignedTechCount += techsToAssign;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (assignedTechCount >= requiredTechs) break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (assignedTechCount >= requiredTechs && primaryTeamDriveInfo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { startHour: locStartHour, startMin: locStartMin, endHour: locEndHour, endMin: locEndMin } = getLocationAvailableTime(location);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const teamStart = eligibleTeams[0].startTime.split(':');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const teamEnd = eligibleTeams[0].endTime.split(':');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayStartTime = new Date(currentDate);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dayStartTime.setHours(Math.max(parseInt(teamStart[0]), locStartHour), Math.max(parseInt(teamStart[1]), locStartMin), 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayEndTime = new Date(currentDate);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dayEndTime.setHours(Math.min(parseInt(teamEnd[0]), locEndHour), Math.min(parseInt(teamEnd[1]), locEndMin), 0, 0);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const availableWorkMinutes = (dayEndTime.getTime() - dayStartTime.getTime()) / 60000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (availableWorkMinutes <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const workToday = Math.min(jobDurationMinutes, availableWorkMinutes);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const jobStartTime = new Date(dayStartTime);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const jobEndTime = new Date(jobStartTime.getTime() + workToday * 60000);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if ((windowStart && jobStartTime < windowStart) || (windowEnd && jobEndTime > windowEnd)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  paramsBroken.push("Install Window");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let newAssignment = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  location: { ...location, scope: location.originalScope || location.scope },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startDateTime: jobStartTime,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endDateTime: jobEndTime,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration: workToday,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  driveTime: primaryTeamDriveInfo.minutes,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  driveMiles: primaryTeamDriveInfo.miles,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignedTeams: assignedTeams,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  day: dayOfWeek,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  overrideParams: [...new Set(paramsBroken)],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requiredTechs: requiredTechs,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: Date.now()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!schedule[currentDate.toISOString()]) schedule[currentDate.toISOString()] = { date: currentDate, teams: [] };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(const assignedTeam of assignedTeams) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let teamEntry = schedule[currentDate.toISOString()].teams.find(t => t.team.id === assignedTeam.teamId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!teamEntry) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalTeam = technicians.find(t => t.id === assignedTeam.teamId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamEntry = { team: originalTeam, assignments: [] };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  schedule[currentDate.toISOString()].teams.push(teamEntry);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamEntry.assignments.push(newAssignment);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  techUsage[assignedTeam.teamId][currentDate.toISOString().split('T')[0]] = (techUsage[assignedTeam.teamId][currentDate.toISOString().split('T')[0]] || 0) + assignedTeam.assignedTechs;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (jobDurationMinutes - workToday <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scheduledThisLocation = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  didScheduleThisDay = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  location.originalScope = location.originalScope || location.scope;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  location.scope = `${jobDurationMinutes - workToday} min remaining`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scheduledThisLocation = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  didScheduleThisDay = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (scheduledThisLocation) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalIndex = unassignedCopy.findIndex(l => l.id === location.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (originalIndex > -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unassignedCopy.splice(originalIndex, 1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (location.scope.includes('min remaining')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unassignedCopy.push(location);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (!didScheduleThisDay && unassignedCopy.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentDate.setDate(currentDate.getDate() + 1);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  lastUnassignedLocations = unassignedCopy;
Â  Â  Â  Â  Â  Â  lastSchedule = schedule;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Restore original scope before saving
Â  Â  Â  Â  Â  Â  locations.forEach(loc => {
Â  Â  Â  Â  Â  Â  Â  Â  if (loc.originalScope) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loc.scope = loc.originalScope;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete loc.originalScope;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  saveScheduleState();
Â  Â  Â  Â  Â  Â  displaySchedule(schedule, lastUnassignedLocations, true);
Â  Â  Â  Â  Â  Â  displayMetrics(schedule, lastUnassignedLocations);
Â  Â  Â  Â  }

Â  Â  Â  Â  function displaySchedule(schedule, unassigned, overrideMode = false) {
Â  Â  Â  Â  Â  Â  const output = document.getElementById('scheduleOutput');
Â  Â  Â  Â  Â  Â  let html = '<h3>ðŸ“… Optimized Installation Schedule</h3>';

Â  Â  Â  Â  Â  Â  if (Object.keys(schedule).length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  output.innerHTML = '<h3>No schedule generated.</h3>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const sortedDays = Object.keys(schedule).sort((a, b) => new Date(a).getTime() - new Date(b).getTime());

Â  Â  Â  Â  Â  Â  sortedDays.forEach(dayKey => {
Â  Â  Â  Â  Â  Â  Â  Â  const dayObj = schedule[dayKey];
Â  Â  Â  Â  Â  Â  Â  Â  let { date, teams } = dayObj;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (teams.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="schedule-day">`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<h4>${date instanceof Date ? date.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' }) : dayKey}</h4>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const assignmentsByLocation = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teams.forEach(teamSchedule => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamSchedule.assignments.forEach(assignment => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const locationId = assignment.location.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const assignmentKey = `${locationId}-${assignment.startDateTime.getTime()}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!assignmentsByLocation[assignmentKey]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignmentsByLocation[assignmentKey] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...assignment,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teams: []
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignment.assignedTeams.forEach(team => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const existingTeam = assignmentsByLocation[assignmentKey].teams.find(t => t.teamId === team.teamId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!existingTeam) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignmentsByLocation[assignmentKey].teams.push(team);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.values(assignmentsByLocation).forEach(assignment => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="assignment">`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const startTime = assignment.startDateTime instanceof Date && !isNaN(assignment.startDateTime) ? assignment.startDateTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }) : assignment.startDateTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const endTime = assignment.endDateTime instanceof Date && !isNaN(assignment.endDateTime) ? assignment.endDateTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }) : assignment.endDateTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="tech-tag">${startTime}</span> - <span class="tech-tag">${endTime}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="location-tag">${assignment.location.siteId}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<p style="margin-top: 5px;"><strong>Assigned Teams:</strong></p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<ul>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const uniqueTeams = assignment.assignedTeams.filter((v, i, a) => a.findIndex(t => t.teamId === v.teamId) === i);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uniqueTeams.forEach(team => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalTeam = technicians.find(t => t.id === team.teamId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const teamName = originalTeam ? originalTeam.teamName : `Team ID: ${team.teamId}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<li style="margin-left: 20px;">${teamName} - ${team.assignedTechs} tech${team.assignedTechs > 1 ? 's' : ''}</li>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `</ul>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<p style="margin-top: 5px;">ðŸ“ ${assignment.location.address}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<p>ðŸ“‹ ${assignment.location.scope}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<p>â±ï¸ Est. Duration: ${formatDuration(assignment.duration)}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<p>ðŸ”Œ Providers: ${(projectProviders || []).join(', ') || 'None'}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (assignment.assignedTeams.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const primaryTeam = assignment.assignedTeams[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalPrimaryTeam = technicians.find(t => t.id === primaryTeam.teamId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (originalPrimaryTeam) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<p>ðŸš— Est. Drive from ${originalPrimaryTeam.teamName}: ${primaryTeam.driveInfo.miles} mi, ${primaryTeam.driveInfo.minutes} min</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (assignment.overrideParams && assignment.overrideParams.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<p style="color:#c33;"><strong>Override: </strong>Scheduled by breaking: ${assignment.overrideParams.join(', ')}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if (!overrideMode && unassigned.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="error">`;
Â  Â  Â  Â  Â  Â  Â  Â  html += `<h4>âš ï¸ Unassigned Locations (${unassigned.length})</h4>`;
Â  Â  Â  Â  Â  Â  Â  Â  unassigned.forEach(loc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<p>â€¢ ${loc.siteId} - ${loc.address} (${loc.scope})</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  html += `<p><strong>Reasons may include: insufficient techs, missing provider/certification, or site not available that day.</strong></p>`;
Â  Â  Â  Â  Â  Â  Â  Â  html += `<button class="btn btn-secondary" id="overrideBtn" onclick="overrideUnassignedSchedule()" style="margin-top:10px;">Override Parameters for Unassigned</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  Â  Â  } else if(overrideMode && unassigned.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="error">`;
Â  Â  Â  Â  Â  Â  Â  Â  html += `<h4>âš ï¸ Still Unassigned Locations (${unassigned.length})</h4>`;
Â  Â  Â  Â  Â  Â  Â  Â  unassigned.forEach(loc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<p>â€¢ ${loc.siteId} - ${loc.address} (${loc.scope})</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  html += `<p><strong>Even with relaxed parameters, these locations could not be scheduled.</strong></p>`;
Â  Â  Â  Â  Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  output.innerHTML = html;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Metrics Display ---
Â  Â  Â  Â  function displayMetrics(schedule, unassigned) {
Â  Â  Â  Â  Â  Â  const metricsDiv = document.getElementById('metrics');
Â  Â  Â  Â  Â  Â  if (!metricsDiv) return;

Â  Â  Â  Â  Â  Â  let totalJobs = 0;
Â  Â  Â  Â  Â  Â  let totalDriveMinutes = 0;
Â  Â  Â  Â  Â  Â  let totalDriveMiles = 0;
Â  Â  Â  Â  Â  Â  let totalDuration = 0;
Â  Â  Â  Â  Â  Â  let totalTeams = 0;

Â  Â  Â  Â  Â  Â  const countedJobs = new Set();
Â  Â  Â  Â  Â  Â  const countedTeams = new Set();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (schedule && typeof schedule === 'object') {
Â  Â  Â  Â  Â  Â  Â  Â  Object.values(schedule).forEach(dayObj => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (dayObj.teams) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dayObj.teams.forEach(teamSchedule => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  countedTeams.add(teamSchedule.team.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamSchedule.assignments.forEach(a => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const jobId = `${a.location.id}-${a.startDateTime.getTime()}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!countedJobs.has(jobId)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalJobs++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalDriveMinutes += Number(a.driveTime) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalDriveMiles += Number(a.driveMiles) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalDuration += Number(a.duration) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  countedJobs.add(jobId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  totalTeams = countedTeams.size;

Â  Â  Â  Â  Â  Â  metricsDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-value">${totalJobs}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Total Jobs Scheduled</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-value">${totalTeams}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Teams Utilized</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-value">${totalDriveMiles.toFixed(1)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Total Drive Miles</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-value">${totalDriveMinutes}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Total Drive Minutes</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-value">${totalDuration}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Total Installation Minutes</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ${unassigned && unassigned.length > 0 ? `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-card" style="background: #dc3545;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-value">${unassigned.length}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Unassigned Locations</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  const overrideBtn = document.getElementById('overrideBtn');
Â  Â  Â  Â  Â  Â  if (overrideBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  overrideBtn.style.display = unassigned.length > 0 ? 'inline-block' : 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Export to XLSX Functionality ---
Â  Â  Â  Â  function exportToXLSX() {
Â  Â  Â  Â  Â  Â  if (Object.keys(lastSchedule).length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Please generate a schedule before exporting.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const data = [];
Â  Â  Â  Â  Â  Â  let sheetName = "Schedule";
Â  Â  Â  Â  Â  Â  let filename = "schedule.xlsx";

Â  Â  Â  Â  Â  Â  const header = [
Â  Â  Â  Â  Â  Â  Â  Â  "Date",
Â  Â  Â  Â  Â  Â  Â  Â  "Team Name",
Â  Â  Â  Â  Â  Â  Â  Â  "Team Size",
Â  Â  Â  Â  Â  Â  Â  Â  "Assigned Techs",
Â  Â  Â  Â  Â  Â  Â  Â  "Start Time",
Â  Â  Â  Â  Â  Â  Â  Â  "End Time",
Â  Â  Â  Â  Â  Â  Â  Â  "Site ID",
Â  Â  Â  Â  Â  Â  Â  Â  "Address",
Â  Â  Â  Â  Â  Â  Â  Â  "Scope of Work",
Â  Â  Â  Â  Â  Â  Â  Â  "Providers",
Â  Â  Â  Â  Â  Â  Â  Â  "Duration (min)",
Â  Â  Â  Â  Â  Â  Â  Â  "Drive Time (min)",
Â  Â  Â  Â  Â  Â  Â  Â  "Drive Distance (mi)",
Â  Â  Â  Â  Â  Â  Â  Â  "Override Reasons"
Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â  data.push(header);

Â  Â  Â  Â  Â  Â  const allAssignments = [];
Â  Â  Â  Â  Â  Â  Object.values(lastSchedule).forEach(dayObj => {
Â  Â  Â  Â  Â  Â  Â  Â  const assignmentsByLocation = {};
Â  Â  Â  Â  Â  Â  Â  Â  dayObj.teams.forEach(teamSchedule => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamSchedule.assignments.forEach(assignment => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const locationId = assignment.location.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const assignmentKey = `${locationId}-${assignment.startDateTime.getTime()}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!assignmentsByLocation[assignmentKey]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignmentsByLocation[assignmentKey] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...assignment,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignedTeams: []
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignment.assignedTeams.forEach(team => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const existingTeam = assignmentsByLocation[assignmentKey].assignedTeams.find(t => t.teamId === team.teamId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!existingTeam) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignmentsByLocation[assignmentKey].assignedTeams.push(team);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  allAssignments.push(...Object.values(assignmentsByLocation));
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  allAssignments.sort((a,b) => a.startDateTime.getTime() - b.startDateTime.getTime());

Â  Â  Â  Â  Â  Â  allAssignments.forEach(assignment => {
Â  Â  Â  Â  Â  Â  Â  Â  const uniqueTeams = assignment.assignedTeams.filter((v, i, a) => a.findIndex(t => t.teamId === v.teamId) === i);
Â  Â  Â  Â  Â  Â  Â  Â  uniqueTeams.forEach(teamData => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalTeam = technicians.find(t => t.id === teamData.teamId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const teamName = originalTeam ? originalTeam.teamName : `Team ID: ${teamData.teamId}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const row = [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  new Date(assignment.startDateTime).toLocaleDateString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  originalTeam ? originalTeam.count : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamData.assignedTechs,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  new Date(assignment.startDateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  new Date(assignment.endDateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignment.location.siteId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignment.location.address,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignment.location.scope,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (projectProviders || []).join(', '),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assignment.duration,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamData.driveInfo.minutes,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  teamData.driveInfo.miles,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (assignment.overrideParams || []).join(', ')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data.push(row);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (lastUnassignedLocations.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const unassignedHeader = ["Unassigned Locations", "", "", "", "", "", "", "", "", "", "", "", "", ""];
Â  Â  Â  Â  Â  Â  Â  Â  Â data.push([]);
Â  Â  Â  Â  Â  Â  Â  Â  Â data.push(unassignedHeader);
Â  Â  Â  Â  Â  Â  Â  Â  Â lastUnassignedLocations.forEach(loc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data.push([
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â "",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â "",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â "",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â "",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â "",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â "",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â "",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â loc.siteId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â loc.address,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â loc.scope,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â (projectProviders || []).join(', '),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â "",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â "",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ""
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ]);
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const wb = XLSX.utils.book_new();
Â  Â  Â  Â  Â  Â  const ws = XLSX.utils.aoa_to_sheet(data);
Â  Â  Â  Â  Â  Â  XLSX.utils.book_append_sheet(wb, ws, sheetName);
Â  Â  Â  Â  Â  Â  XLSX.writeFile(wb, filename);
Â  Â  Â  Â  }

Â  Â  </script>
</body>
</html>
